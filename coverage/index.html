<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Campaign-saas</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.2/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.2/favicon_green.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.13.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2025-11-29T02:43:04-05:00">2025-11-29T02:43:04-05:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="green">
  96.47%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         22.77
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>41</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>1614</b> relevant lines,
    <span class="green"><b>1557</b> lines covered</span> and
    <span class="red"><b>57</b> lines missed. </span>
    (<span class="green">
  96.47%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a3d56df52c7f1836a9f021393a64953a2b8e8d80" class="src_link" title="app/controllers/api/v1/agent_configs_controller.rb">app/controllers/api/v1/agent_configs_controller.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">85.33 %</td>
            <td class="cell--number">208</td>
            <td class="cell--number">75</td>
            <td class="cell--number">64</td>
            <td class="cell--number">11</td>
            <td class="cell--number">4.49</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#504690279da9ea266f4358ae36e51fe421b50204" class="src_link" title="app/controllers/api/v1/api_keys_controller.rb">app/controllers/api/v1/api_keys_controller.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">85.19 %</td>
            <td class="cell--number">58</td>
            <td class="cell--number">27</td>
            <td class="cell--number">23</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4.19</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#0e7411846c6d2f1ebb859bda1a7eabda40e8d36b" class="src_link" title="app/controllers/api/v1/base_controller.rb">app/controllers/api/v1/base_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.00 %</td>
            <td class="cell--number">64</td>
            <td class="cell--number">25</td>
            <td class="cell--number">24</td>
            <td class="cell--number">1</td>
            <td class="cell--number">71.60</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#12b8a84eb5efd0c4181b90b3c91da33d8c0669d5" class="src_link" title="app/controllers/api/v1/campaigns_controller.rb">app/controllers/api/v1/campaigns_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">100</td>
            <td class="cell--number">43</td>
            <td class="cell--number">43</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.28</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cc7488bf61495576ed01829dc935b0dae879c36b" class="src_link" title="app/controllers/api/v1/email_configs_controller.rb">app/controllers/api/v1/email_configs_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">81</td>
            <td class="cell--number">32</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.59</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#aa354e341381aab578a184aafd334d042aa53d36" class="src_link" title="app/controllers/api/v1/leads_controller.rb">app/controllers/api/v1/leads_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">93.91 %</td>
            <td class="cell--number">321</td>
            <td class="cell--number">115</td>
            <td class="cell--number">108</td>
            <td class="cell--number">7</td>
            <td class="cell--number">5.59</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a149d071471fba0f4cee3dcfa82d5bf395b61d52" class="src_link" title="app/controllers/api/v1/oauth_statuses_controller.rb">app/controllers/api/v1/oauth_statuses_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">26</td>
            <td class="cell--number">11</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.64</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#33b7f2000d863f06e2fee1b3f19f8cc8976d5742" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">67</td>
            <td class="cell--number">33</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0</td>
            <td class="cell--number">30.64</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#80af6ef35649a50673bd184ec3f9420f63ed4e1e" class="src_link" title="app/controllers/campaigns_controller.rb">app/controllers/campaigns_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.50 %</td>
            <td class="cell--number">89</td>
            <td class="cell--number">40</td>
            <td class="cell--number">39</td>
            <td class="cell--number">1</td>
            <td class="cell--number">29.93</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4bfc9f8b9db216c106628bdc0fd8507b37db746b" class="src_link" title="app/controllers/oauth_controller.rb">app/controllers/oauth_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">101</td>
            <td class="cell--number">51</td>
            <td class="cell--number">51</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.29</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4fd8c8790733285c4716ab69553399254fc33de0" class="src_link" title="app/controllers/users/registrations_controller.rb">app/controllers/users/registrations_controller.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">89.58 %</td>
            <td class="cell--number">102</td>
            <td class="cell--number">48</td>
            <td class="cell--number">43</td>
            <td class="cell--number">5</td>
            <td class="cell--number">3.75</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#effef0f26a95c27c3a47edf93d8f2b59479f214c" class="src_link" title="app/controllers/users/sessions_controller.rb">app/controllers/users/sessions_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.61 %</td>
            <td class="cell--number">136</td>
            <td class="cell--number">59</td>
            <td class="cell--number">57</td>
            <td class="cell--number">2</td>
            <td class="cell--number">4.02</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9761d38fcf9e19cbd7dab3415880d8a0743336e1" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#dd68fe0b2890bc93a2ee3a4e699b022c9182e527" class="src_link" title="app/helpers/markdown_helper.rb">app/helpers/markdown_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.26 %</td>
            <td class="cell--number">146</td>
            <td class="cell--number">73</td>
            <td class="cell--number">71</td>
            <td class="cell--number">2</td>
            <td class="cell--number">22.74</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef3ee4490ed5e15f882ef9e79719133120bb3b86" class="src_link" title="app/jobs/agent_execution_job.rb">app/jobs/agent_execution_job.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">87.50 %</td>
            <td class="cell--number">66</td>
            <td class="cell--number">24</td>
            <td class="cell--number">21</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2.92</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#511aa129cfc56e56e2128835cc1fdcab0d4ad7a2" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8d47a033a2a92a676db8f13a85acd465c8aa5e53" class="src_link" title="app/lib/custom_failure_app.rb">app/lib/custom_failure_app.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2.78</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8d2edefc653bcda077ae63b67427bd365abe6894" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">5</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b059d99df1459677cbeae70bc5746652b5ea7391" class="src_link" title="app/mailers/campaign_mailer.rb">app/mailers/campaign_mailer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">31</td>
            <td class="cell--number">12</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0</td>
            <td class="cell--number">5.58</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8c185821126815c935f5d79a1a896b0e851041a1" class="src_link" title="app/models/agent_config.rb">app/models/agent_config.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">53</td>
            <td class="cell--number">23</td>
            <td class="cell--number">23</td>
            <td class="cell--number">0</td>
            <td class="cell--number">12.78</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f424c27e828cb8b2e7a8aea8b7b57da6afa1da4c" class="src_link" title="app/models/agent_output.rb">app/models/agent_output.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">48</td>
            <td class="cell--number">15</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.40</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#52de9283f8876bebe1a6f09646894b4030fb7bfd" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f93af2e26f9786cfcb1aa3f3ae8a0b238c45d286" class="src_link" title="app/models/campaign.rb">app/models/campaign.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">54</td>
            <td class="cell--number">21</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0</td>
            <td class="cell--number">43.62</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ff3a5aec398ad0d0fc9c850f8f632c67504d1592" class="src_link" title="app/models/concerns/agent_constants.rb">app/models/concerns/agent_constants.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">59</td>
            <td class="cell--number">18</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7deed286d3944e0e593bb7c65c68961ec3992393" class="src_link" title="app/models/concerns/jsonb_validator.rb">app/models/concerns/jsonb_validator.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.50 %</td>
            <td class="cell--number">113</td>
            <td class="cell--number">40</td>
            <td class="cell--number">39</td>
            <td class="cell--number">1</td>
            <td class="cell--number">304.10</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5052f3936865bf66478b11b4aeb6eba8b4897aa5" class="src_link" title="app/models/lead.rb">app/models/lead.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">44.89</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c22a560aed2802b343eb077ccd1d8e207434cae1" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">12</td>
            <td class="cell--number">5</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.20</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#97547017f4b3c6751a1513cd7cb1c8aecec1ab41" class="src_link" title="app/serializers/agent_config_serializer.rb">app/serializers/agent_config_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">5.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6cc7790edbfba55456ddfd243e471d6636babfdb" class="src_link" title="app/serializers/agent_output_serializer.rb">app/serializers/agent_output_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.33</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d5f2ef33df5dc8787e909835786bb3755081c942" class="src_link" title="app/serializers/base_serializer.rb">app/serializers/base_serializer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">61.11 %</td>
            <td class="cell--number">63</td>
            <td class="cell--number">18</td>
            <td class="cell--number">11</td>
            <td class="cell--number">7</td>
            <td class="cell--number">11.33</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5033a43e0d64a16aee56cc0b1a44e49f4daef39d" class="src_link" title="app/serializers/campaign_serializer.rb">app/serializers/campaign_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">16</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.67</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#12d0eeb791adc55b9e0fafa4cb37253bd8a9d20d" class="src_link" title="app/serializers/lead_serializer.rb">app/serializers/lead_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">11.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d4b328b2dc1e5ae19f0a1b53846a6edb8a44df6d" class="src_link" title="app/services/agents/critique_agent.rb">app/services/agents/critique_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.22 %</td>
            <td class="cell--number">232</td>
            <td class="cell--number">72</td>
            <td class="cell--number">70</td>
            <td class="cell--number">2</td>
            <td class="cell--number">16.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#741e1d5ebff4760a77f743feb2223f7835b4eede" class="src_link" title="app/services/agents/design_agent.rb">app/services/agents/design_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">203</td>
            <td class="cell--number">69</td>
            <td class="cell--number">69</td>
            <td class="cell--number">0</td>
            <td class="cell--number">13.88</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8ca4839bca54b1f2e2afdd4fae89a24f58e4b1e0" class="src_link" title="app/services/agents/search_agent.rb">app/services/agents/search_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">127</td>
            <td class="cell--number">43</td>
            <td class="cell--number">43</td>
            <td class="cell--number">0</td>
            <td class="cell--number">15.56</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#07a85b4b12642589644693c0b3779002835162f5" class="src_link" title="app/services/agents/writer_agent.rb">app/services/agents/writer_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">276</td>
            <td class="cell--number">106</td>
            <td class="cell--number">106</td>
            <td class="cell--number">0</td>
            <td class="cell--number">26.91</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#00ebc34188ddbf1df657b7c96d32bb07ae2db59d" class="src_link" title="app/services/api_key_service.rb">app/services/api_key_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">62</td>
            <td class="cell--number">19</td>
            <td class="cell--number">19</td>
            <td class="cell--number">0</td>
            <td class="cell--number">30.26</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e31c4fe0093b9112f117ae8bff788e0410b53bc5" class="src_link" title="app/services/email_sender_service.rb">app/services/email_sender_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.18 %</td>
            <td class="cell--number">399</td>
            <td class="cell--number">177</td>
            <td class="cell--number">172</td>
            <td class="cell--number">5</td>
            <td class="cell--number">13.64</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#00b936eef0f2e1f5509baeb8fdf3f32a124f887e" class="src_link" title="app/services/gmail_oauth_service.rb">app/services/gmail_oauth_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">94.37 %</td>
            <td class="cell--number">171</td>
            <td class="cell--number">71</td>
            <td class="cell--number">67</td>
            <td class="cell--number">4</td>
            <td class="cell--number">7.27</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#98eab4954506e8995ceb4f1647050f1e9fdeb99b" class="src_link" title="app/services/lead_agent_service.rb">app/services/lead_agent_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.73 %</td>
            <td class="cell--number">441</td>
            <td class="cell--number">158</td>
            <td class="cell--number">156</td>
            <td class="cell--number">2</td>
            <td class="cell--number">33.59</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e1679d29d6c25150cb399592347446f885abcb1f" class="src_link" title="app/services/orchestrator.rb">app/services/orchestrator.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">163</td>
            <td class="cell--number">53</td>
            <td class="cell--number">53</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.30</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent">
      <span class="green">
  94.45%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         10.7
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Controllers"></a>

  <div>
    <b>12</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>559</b> relevant lines,
    <span class="green"><b>528</b> lines covered</span> and
    <span class="red"><b>31</b> lines missed. </span>
    (<span class="green">
  94.45%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a3d56df52c7f1836a9f021393a64953a2b8e8d80" class="src_link" title="app/controllers/api/v1/agent_configs_controller.rb">app/controllers/api/v1/agent_configs_controller.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">85.33 %</td>
            <td class="cell--number">208</td>
            <td class="cell--number">75</td>
            <td class="cell--number">64</td>
            <td class="cell--number">11</td>
            <td class="cell--number">4.49</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#504690279da9ea266f4358ae36e51fe421b50204" class="src_link" title="app/controllers/api/v1/api_keys_controller.rb">app/controllers/api/v1/api_keys_controller.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">85.19 %</td>
            <td class="cell--number">58</td>
            <td class="cell--number">27</td>
            <td class="cell--number">23</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4.19</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#0e7411846c6d2f1ebb859bda1a7eabda40e8d36b" class="src_link" title="app/controllers/api/v1/base_controller.rb">app/controllers/api/v1/base_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.00 %</td>
            <td class="cell--number">64</td>
            <td class="cell--number">25</td>
            <td class="cell--number">24</td>
            <td class="cell--number">1</td>
            <td class="cell--number">71.60</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#12b8a84eb5efd0c4181b90b3c91da33d8c0669d5" class="src_link" title="app/controllers/api/v1/campaigns_controller.rb">app/controllers/api/v1/campaigns_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">100</td>
            <td class="cell--number">43</td>
            <td class="cell--number">43</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.28</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cc7488bf61495576ed01829dc935b0dae879c36b" class="src_link" title="app/controllers/api/v1/email_configs_controller.rb">app/controllers/api/v1/email_configs_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">81</td>
            <td class="cell--number">32</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.59</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#aa354e341381aab578a184aafd334d042aa53d36" class="src_link" title="app/controllers/api/v1/leads_controller.rb">app/controllers/api/v1/leads_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">93.91 %</td>
            <td class="cell--number">321</td>
            <td class="cell--number">115</td>
            <td class="cell--number">108</td>
            <td class="cell--number">7</td>
            <td class="cell--number">5.59</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a149d071471fba0f4cee3dcfa82d5bf395b61d52" class="src_link" title="app/controllers/api/v1/oauth_statuses_controller.rb">app/controllers/api/v1/oauth_statuses_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">26</td>
            <td class="cell--number">11</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.64</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#33b7f2000d863f06e2fee1b3f19f8cc8976d5742" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">67</td>
            <td class="cell--number">33</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0</td>
            <td class="cell--number">30.64</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#80af6ef35649a50673bd184ec3f9420f63ed4e1e" class="src_link" title="app/controllers/campaigns_controller.rb">app/controllers/campaigns_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.50 %</td>
            <td class="cell--number">89</td>
            <td class="cell--number">40</td>
            <td class="cell--number">39</td>
            <td class="cell--number">1</td>
            <td class="cell--number">29.93</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4bfc9f8b9db216c106628bdc0fd8507b37db746b" class="src_link" title="app/controllers/oauth_controller.rb">app/controllers/oauth_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">101</td>
            <td class="cell--number">51</td>
            <td class="cell--number">51</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.29</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4fd8c8790733285c4716ab69553399254fc33de0" class="src_link" title="app/controllers/users/registrations_controller.rb">app/controllers/users/registrations_controller.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">89.58 %</td>
            <td class="cell--number">102</td>
            <td class="cell--number">48</td>
            <td class="cell--number">43</td>
            <td class="cell--number">5</td>
            <td class="cell--number">3.75</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#effef0f26a95c27c3a47edf93d8f2b59479f214c" class="src_link" title="app/controllers/users/sessions_controller.rb">app/controllers/users/sessions_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.61 %</td>
            <td class="cell--number">136</td>
            <td class="cell--number">59</td>
            <td class="cell--number">57</td>
            <td class="cell--number">2</td>
            <td class="cell--number">4.02</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Channels">
  <h2>
    <span class="group_name">Channels</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Channels"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent">
      <span class="green">
  99.25%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         104.06
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Models"></a>

  <div>
    <b>8</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>133</b> relevant lines,
    <span class="green"><b>132</b> lines covered</span> and
    <span class="red"><b>1</b> lines missed. </span>
    (<span class="green">
  99.25%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8c185821126815c935f5d79a1a896b0e851041a1" class="src_link" title="app/models/agent_config.rb">app/models/agent_config.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">53</td>
            <td class="cell--number">23</td>
            <td class="cell--number">23</td>
            <td class="cell--number">0</td>
            <td class="cell--number">12.78</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f424c27e828cb8b2e7a8aea8b7b57da6afa1da4c" class="src_link" title="app/models/agent_output.rb">app/models/agent_output.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">48</td>
            <td class="cell--number">15</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.40</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#52de9283f8876bebe1a6f09646894b4030fb7bfd" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f93af2e26f9786cfcb1aa3f3ae8a0b238c45d286" class="src_link" title="app/models/campaign.rb">app/models/campaign.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">54</td>
            <td class="cell--number">21</td>
            <td class="cell--number">21</td>
            <td class="cell--number">0</td>
            <td class="cell--number">43.62</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ff3a5aec398ad0d0fc9c850f8f632c67504d1592" class="src_link" title="app/models/concerns/agent_constants.rb">app/models/concerns/agent_constants.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">59</td>
            <td class="cell--number">18</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7deed286d3944e0e593bb7c65c68961ec3992393" class="src_link" title="app/models/concerns/jsonb_validator.rb">app/models/concerns/jsonb_validator.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.50 %</td>
            <td class="cell--number">113</td>
            <td class="cell--number">40</td>
            <td class="cell--number">39</td>
            <td class="cell--number">1</td>
            <td class="cell--number">304.10</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5052f3936865bf66478b11b4aeb6eba8b4897aa5" class="src_link" title="app/models/lead.rb">app/models/lead.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">44.89</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c22a560aed2802b343eb077ccd1d8e207434cae1" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">12</td>
            <td class="cell--number">5</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.20</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         4.44
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Mailers"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>16</b> relevant lines,
    <span class="green"><b>16</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8d2edefc653bcda077ae63b67427bd365abe6894" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">5</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b059d99df1459677cbeae70bc5746652b5ea7391" class="src_link" title="app/mailers/campaign_mailer.rb">app/mailers/campaign_mailer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">31</td>
            <td class="cell--number">12</td>
            <td class="cell--number">12</td>
            <td class="cell--number">0</td>
            <td class="cell--number">5.58</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent">
      <span class="green">
  97.3%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         22.45
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Helpers"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>74</b> relevant lines,
    <span class="green"><b>72</b> lines covered</span> and
    <span class="red"><b>2</b> lines missed. </span>
    (<span class="green">
  97.3%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9761d38fcf9e19cbd7dab3415880d8a0743336e1" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#dd68fe0b2890bc93a2ee3a4e699b022c9182e527" class="src_link" title="app/helpers/markdown_helper.rb">app/helpers/markdown_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.26 %</td>
            <td class="cell--number">146</td>
            <td class="cell--number">73</td>
            <td class="cell--number">71</td>
            <td class="cell--number">2</td>
            <td class="cell--number">22.74</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent">
      <span class="yellow">
  88.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         2.84
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Jobs"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>25</b> relevant lines,
    <span class="green"><b>22</b> lines covered</span> and
    <span class="red"><b>3</b> lines missed. </span>
    (<span class="yellow">
  88.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef3ee4490ed5e15f882ef9e79719133120bb3b86" class="src_link" title="app/jobs/agent_execution_job.rb">app/jobs/agent_execution_job.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">87.50 %</td>
            <td class="cell--number">66</td>
            <td class="cell--number">24</td>
            <td class="cell--number">21</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2.92</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#511aa129cfc56e56e2128835cc1fdcab0d4ad7a2" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         2.78
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Libraries"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>9</b> relevant lines,
    <span class="green"><b>9</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8d47a033a2a92a676db8f13a85acd465c8aa5e53" class="src_link" title="app/lib/custom_failure_app.rb">app/lib/custom_failure_app.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2.78</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Services">
  <h2>
    <span class="group_name">Services</span>
    (<span class="covered_percent">
      <span class="green">
  98.31%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         19.3
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Services"></a>

  <div>
    <b>9</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>768</b> relevant lines,
    <span class="green"><b>755</b> lines covered</span> and
    <span class="red"><b>13</b> lines missed. </span>
    (<span class="green">
  98.31%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d4b328b2dc1e5ae19f0a1b53846a6edb8a44df6d" class="src_link" title="app/services/agents/critique_agent.rb">app/services/agents/critique_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.22 %</td>
            <td class="cell--number">232</td>
            <td class="cell--number">72</td>
            <td class="cell--number">70</td>
            <td class="cell--number">2</td>
            <td class="cell--number">16.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#741e1d5ebff4760a77f743feb2223f7835b4eede" class="src_link" title="app/services/agents/design_agent.rb">app/services/agents/design_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">203</td>
            <td class="cell--number">69</td>
            <td class="cell--number">69</td>
            <td class="cell--number">0</td>
            <td class="cell--number">13.88</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8ca4839bca54b1f2e2afdd4fae89a24f58e4b1e0" class="src_link" title="app/services/agents/search_agent.rb">app/services/agents/search_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">127</td>
            <td class="cell--number">43</td>
            <td class="cell--number">43</td>
            <td class="cell--number">0</td>
            <td class="cell--number">15.56</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#07a85b4b12642589644693c0b3779002835162f5" class="src_link" title="app/services/agents/writer_agent.rb">app/services/agents/writer_agent.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">276</td>
            <td class="cell--number">106</td>
            <td class="cell--number">106</td>
            <td class="cell--number">0</td>
            <td class="cell--number">26.91</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#00ebc34188ddbf1df657b7c96d32bb07ae2db59d" class="src_link" title="app/services/api_key_service.rb">app/services/api_key_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">62</td>
            <td class="cell--number">19</td>
            <td class="cell--number">19</td>
            <td class="cell--number">0</td>
            <td class="cell--number">30.26</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e31c4fe0093b9112f117ae8bff788e0410b53bc5" class="src_link" title="app/services/email_sender_service.rb">app/services/email_sender_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.18 %</td>
            <td class="cell--number">399</td>
            <td class="cell--number">177</td>
            <td class="cell--number">172</td>
            <td class="cell--number">5</td>
            <td class="cell--number">13.64</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#00b936eef0f2e1f5509baeb8fdf3f32a124f887e" class="src_link" title="app/services/gmail_oauth_service.rb">app/services/gmail_oauth_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">94.37 %</td>
            <td class="cell--number">171</td>
            <td class="cell--number">71</td>
            <td class="cell--number">67</td>
            <td class="cell--number">4</td>
            <td class="cell--number">7.27</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#98eab4954506e8995ceb4f1647050f1e9fdeb99b" class="src_link" title="app/services/lead_agent_service.rb">app/services/lead_agent_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.73 %</td>
            <td class="cell--number">441</td>
            <td class="cell--number">158</td>
            <td class="cell--number">156</td>
            <td class="cell--number">2</td>
            <td class="cell--number">33.59</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e1679d29d6c25150cb399592347446f885abcb1f" class="src_link" title="app/services/orchestrator.rb">app/services/orchestrator.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">163</td>
            <td class="cell--number">53</td>
            <td class="cell--number">53</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.30</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent">
      <span class="red">
  76.67%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         9.2
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Ungrouped"></a>

  <div>
    <b>5</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>30</b> relevant lines,
    <span class="green"><b>23</b> lines covered</span> and
    <span class="red"><b>7</b> lines missed. </span>
    (<span class="red">
  76.67%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#97547017f4b3c6751a1513cd7cb1c8aecec1ab41" class="src_link" title="app/serializers/agent_config_serializer.rb">app/serializers/agent_config_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">5.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6cc7790edbfba55456ddfd243e471d6636babfdb" class="src_link" title="app/serializers/agent_output_serializer.rb">app/serializers/agent_output_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">17</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.33</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d5f2ef33df5dc8787e909835786bb3755081c942" class="src_link" title="app/serializers/base_serializer.rb">app/serializers/base_serializer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">61.11 %</td>
            <td class="cell--number">63</td>
            <td class="cell--number">18</td>
            <td class="cell--number">11</td>
            <td class="cell--number">7</td>
            <td class="cell--number">11.33</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5033a43e0d64a16aee56cc0b1a44e49f4daef39d" class="src_link" title="app/serializers/campaign_serializer.rb">app/serializers/campaign_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">16</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">3.67</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#12d0eeb791adc55b9e0fafa4cb37253bd8a9d20d" class="src_link" title="app/serializers/lead_serializer.rb">app/serializers/lead_serializer.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3</td>
            <td class="cell--number">0</td>
            <td class="cell--number">11.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.13.2<br/>
        using Cucumber Features
      </div>

      <div class="source_files">
      
        <div class="source_table" id="a3d56df52c7f1836a9f021393a64953a2b8e8d80">
  <div class="header">
    <h3>app/controllers/api/v1/agent_configs_controller.rb</h3>
    <h4>
      <span class="yellow">
  85.33%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>75</b> relevant lines.
      <span class="green"><b>64</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class AgentConfigsController &lt; BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">      # GET /api/v1/campaigns/:campaign_id/agent_configs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">      # Returns all agent configs for a campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="9">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.includes(:agent_configs).find_by(id: params[:campaign_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="11">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="12">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="13">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="16">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        configs = campaign.agent_configs.map { |config| AgentConfigSerializer.serialize(config) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="18">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">          campaignId: campaign.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">          configs: configs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">        }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      # GET /api/v1/campaigns/:campaign_id/agent_configs/:id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      # Returns a specific agent config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def show</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="29">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.includes(:agent_configs).find_by(id: params[:campaign_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="31">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="36">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        config = campaign.agent_configs.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="38">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        unless config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Agent config not found&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="43">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        render json: AgentConfigSerializer.serialize(config), status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      # POST /api/v1/campaigns/:campaign_id/agent_configs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      # Creates a new agent config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="49">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="51">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.includes(:agent_configs).find_by(id: params[:campaign_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="53">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="54">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="55">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        # Normalize agent_name (handle both camelCase and snake_case)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        # Rails converts top-level camelCase JSON keys to snake_case (agentConfig -&gt; agent_config)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        # But nested keys may remain in camelCase (agentName stays as agentName)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        # Get agent_name from raw params (before permit filters it)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="62">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        raw_config = params[:agent_config] || params[&quot;agent_config&quot;] || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="63">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        agent_name = raw_config[:agent_name] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">                     raw_config[:agentName] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">                     raw_config[&quot;agent_name&quot;] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">                     raw_config[&quot;agentName&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        # Validate agent name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="69">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        unless AgentConstants::VALID_AGENT_NAMES.include?(agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="70">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Invalid agent name. Must be one of: SEARCH, WRITER, CRITIQUE, DESIGN&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="71">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">        # Check if config already exists - reload association to avoid cache issues</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="75">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        campaign.agent_configs.reload</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="76">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        existing_config = campaign.agent_configs.find_by(agent_name: agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="77">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        if existing_config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="78">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Agent config already exists for this campaign&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="79">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="82">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        config = campaign.agent_configs.build(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">          agent_name: agent_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">          enabled: agent_config_params[:enabled] != false, # Default to true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">          settings: agent_config_params[:settings] || {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="88">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        if config.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="89">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          render json: AgentConfigSerializer.serialize(config), status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">          render json: { errors: config.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      # PATCH/PUT /api/v1/campaigns/:campaign_id/agent_configs/:id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">      # Updates an existing agent config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="98">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def update</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="100">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.includes(:agent_configs).find_by(id: params[:campaign_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="102">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="107">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        config = campaign.agent_configs.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="109">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        unless config</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">          render json: { errors: [ &quot;Agent config not found&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">        # Only allow updating enabled status and settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">        # Agent name cannot be changed</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="116">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        update_params = agent_config_params.except(:agent_name, :agentName)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="118">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        if config.update(update_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="119">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          render json: AgentConfigSerializer.serialize(config), status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">          render json: { errors: config.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">      # DELETE /api/v1/campaigns/:campaign_id/agent_configs/:id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">      # Deletes an agent config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="128">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="130">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.includes(:agent_configs).find_by(id: params[:campaign_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="132">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="137">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        config = campaign.agent_configs.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="139">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        if config</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="140">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          config.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="141">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          head :no_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="143">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Agent config not found&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="147">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="149">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def agent_config_params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">        # Handle both camelCase (agentConfig) and snake_case (agent_config)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">        # Rails converts top-level camelCase JSON keys to snake_case automatically</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">        # So &quot;agentConfig&quot; in JSON becomes &quot;agent_config&quot; in params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">        # But nested keys may remain in camelCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="154">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        config_params = params[:agent_config] || params[&quot;agent_config&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="156">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        unless config_params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">          # Fallback: try to get from top-level params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">          return params.permit(:agent_name, :agentName, :enabled, settings: {})</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">        # Permit all settings keys explicitly for security</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">        # Settings vary by agent type, so we permit all known keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">        # Note: permit accepts both symbol and string keys, and both camelCase and snake_case</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="164">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        permitted = config_params.permit(:agent_name, :agentName, &quot;agent_name&quot;, &quot;agentName&quot;, :enabled)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="166">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        settings_data = config_params[:settings] || config_params[&quot;settings&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="167">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        if settings_data.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="168">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          permitted[:settings] = permit_settings(settings_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="170">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          permitted[:settings] = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="173">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">        permitted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="176">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def permit_settings(settings_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">        # Permit all known settings keys used by different agent types</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">        # WRITER: tone, sender_persona, email_length, personalization_level, primary_cta_type,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">        #         cta_softness, num_variants_per_lead, product_info, sender_company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">        # SEARCH: search_depth, max_queries_per_lead, extracted_fields, on_low_info_behavior</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">        # CRITIQUE: checks (hash), strictness, min_score_for_send, rewrite_policy, variant_selection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">        # DESIGN: format, allow_bold/allowBold, allow_italic/allowItalic, allow_bullets/allowBullets,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">        #         cta_style/ctaStyle, font_family/fontFamily</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">        # Note: DESIGN agent settings accept both camelCase (from frontend) and snake_case (for consistency)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="185">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        settings_params.permit(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">          # WRITER agent settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">          :tone, :sender_persona, :email_length, :personalization_level,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">          :primary_cta_type, :cta_softness, :num_variants_per_lead,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">          :product_info, :sender_company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">          # SEARCH agent settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">          :search_depth, :max_queries_per_lead, :on_low_info_behavior,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">          # CRITIQUE agent settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">          :strictness, :min_score_for_send, :rewrite_policy, :variant_selection,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">          # DESIGN agent settings - accept both camelCase (from frontend) and snake_case</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby">          :format,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">          :allow_bold, :allowBold,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">          :allow_italic, :allowItalic,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">          :allow_bullets, :allowBullets,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">          :cta_style, :ctaStyle,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">          :font_family, :fontFamily,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">          # Nested structures</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">          checks: {},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">          extracted_fields: []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="504690279da9ea266f4358ae36e51fe421b50204">
  <div class="header">
    <h3>app/controllers/api/v1/api_keys_controller.rb</h3>
    <h4>
      <span class="yellow">
  85.19%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>27</b> relevant lines.
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class ApiKeysController &lt; BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="5">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="7">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        unless user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">          render json: { error: &quot;Unauthorized&quot; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="12">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">          llmApiKey: user.llm_api_key.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">          tavilyApiKey: user.tavily_api_key.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def update</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="19">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="21">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        unless user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">          render json: { error: &quot;Unauthorized&quot; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="26">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        direct_params = params.permit(:llmApiKey, :tavilyApiKey)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="27">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        nested_params = params.fetch(:api_keys, {}).permit(:llmApiKey, :tavilyApiKey)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="29">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        updates = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="30">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        if direct_params.key?(:llmApiKey) || nested_params.key?(:llmApiKey)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="31">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          updates[:llm_api_key] = direct_params[:llmApiKey] || nested_params[:llmApiKey]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="33">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        if direct_params.key?(:tavilyApiKey) || nested_params.key?(:tavilyApiKey)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="34">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          updates[:tavily_api_key] = direct_params[:tavilyApiKey] || nested_params[:tavilyApiKey]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="37">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        if updates.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">            llmApiKey: user.llm_api_key.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">            tavilyApiKey: user.tavily_api_key.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="45">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        if user.update(updates)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="46">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">            llmApiKey: user.llm_api_key.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">            tavilyApiKey: user.tavily_api_key.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">            error: user.errors.full_messages.join(&quot;, &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">          }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0e7411846c6d2f1ebb859bda1a7eabda40e8d36b">
  <div class="header">
    <h3>app/controllers/api/v1/base_controller.rb</h3>
    <h4>
      <span class="green">
  96.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>25</b> relevant lines.
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class BaseController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      protect_from_forgery with: :null_session</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      skip_before_action :verify_authenticity_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">      # Set request format to JSON for API requests to ensure proper handling</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      before_action :set_json_format</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      before_action :authenticate_user!, unless: :skip_auth?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def skip_auth?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">        # Skip authentication when explicitly disabled, otherwise respect environment defaults</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="380" data-linenumber="15">
            
              <span class="hits">380</span>
            

            

            <code class="ruby">        disable_auth = ENV[&quot;DISABLE_AUTH&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="380" data-linenumber="16">
            
              <span class="hits">380</span>
            

            

            <code class="ruby">        return true if disable_auth == &quot;true&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="17">
            
              <span class="hits">78</span>
            

            

            <code class="ruby">        return false if disable_auth == &quot;false&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">        # Default behaviour: skip in development for convenience</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">        # For API controllers we avoid relying on Devise&#39;s current_user (which expects</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">        # a full Warden stack) and work directly with warden when available.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">        #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        # 1) If auth is skipped (development helpers), always fall back to an admin user.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">        # 2) Otherwise, try to read the user from warden, rescuing MissingWarden so specs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">        #    and nonmiddleware contexts don&#39;t blow up.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="217" data-linenumber="30">
            
              <span class="hits">217</span>
            

            

            <code class="ruby">        if skip_auth?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="174" data-linenumber="31">
            
              <span class="hits">174</span>
            

            

            <code class="ruby">          admin_user = User.find_by(email: &quot;admin@example.com&quot;) || User.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">            email: &quot;admin@example.com&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">            password: &quot;password123&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">            password_confirmation: &quot;password123&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">            name: &quot;Admin User&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">            first_name: &quot;Admin&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">            last_name: &quot;User&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">            workspace_name: &quot;Admin Workspace&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">            job_title: &quot;Administrator&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="174" data-linenumber="41">
            
              <span class="hits">174</span>
            

            

            <code class="ruby">          return normalize_user(admin_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="44">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">        authenticated_user = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="47">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">          if respond_to?(:warden) &amp;&amp; warden</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="48">
            
              <span class="hits">42</span>
            

            

            <code class="ruby">            authenticated_user = warden.user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        rescue Devise::MissingWarden</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">          authenticated_user = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="54">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">        authenticated_user = normalize_user(authenticated_user) if authenticated_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="55">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">        authenticated_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      # Force JSON format for API requests to ensure Devise returns 401 instead of redirecting</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def set_json_format</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="161" data-linenumber="60">
            
              <span class="hits">161</span>
            

            

            <code class="ruby">        request.format = :json if request.path.start_with?(&quot;/api/&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="12b8a84eb5efd0c4181b90b3c91da33d8c0669d5">
  <div class="header">
    <h3>app/controllers/api/v1/campaigns_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>43</b> relevant lines.
      <span class="green"><b>43</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class CampaignsController &lt; BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">        # Only return campaigns belonging to the current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries when accessing associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="7">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        campaigns = current_user.campaigns.includes(:leads, :agent_configs)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="8">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        render json: CampaignSerializer.serialize_collection(campaigns)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">        # Associate campaign with current user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="13">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.build(campaign_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="14">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        if campaign.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="15">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          render json: CampaignSerializer.serialize(campaign), status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="17">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          render json: { errors: campaign.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def update</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">        # Only allow updating campaigns that belong to current user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="23">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="24">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        if campaign &amp;&amp; campaign.update(campaign_params)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: CampaignSerializer.serialize(campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="27">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: campaign ? campaign.errors.full_messages : [ &quot;Not found or unauthorized&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">        # Only allow deleting campaigns that belong to current user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="33">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="34">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        if campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="35">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          campaign.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="36">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          head :no_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      # POST /api/v1/campaigns/:id/send_emails</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      # Sends emails to all ready leads in the campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def send_emails</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries when loading leads and agent_outputs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="47">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.includes(:leads, leads: :agent_outputs).find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="49">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="55">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          result = EmailSenderService.send_emails_for_campaign(campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">            success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">            sent: result[:sent],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">            failed: result[:failed],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">            errors: result[:errors]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">          }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="64">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">            success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">            error: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">          }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="73">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def campaign_params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">        # Convert camelCase to snake_case for database</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="75">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">        params_hash = params.require(:campaign).permit(:title, sharedSettings: {}).to_h.with_indifferent_access</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">        # Handle sharedSettings - merge with existing if updating</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="78">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">        if params_hash[:sharedSettings]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="79">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">          shared_settings = params_hash.delete(:sharedSettings)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="80">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">          if params[:id]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="81">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            campaign = current_user.campaigns.find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="82">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            if campaign</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">              # Merge with existing shared_settings when updating</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">              # Use read_attribute to get actual DB value, not the getter with defaults</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="85">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              existing = campaign.read_attribute(:shared_settings) || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="86">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              params_hash[:shared_settings] = existing.deep_merge(shared_settings)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">            else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="88">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              params_hash[:shared_settings] = shared_settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">            # Use as-is when creating</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="92">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">            params_hash[:shared_settings] = shared_settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="96">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">        params_hash</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cc7488bf61495576ed01829dc935b0dae879c36b">
  <div class="header">
    <h3>app/controllers/api/v1/email_configs_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class EmailConfigsController &lt; BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">      # GET /api/v1/email_config</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">      # Returns current user&#39;s email configuration</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="8">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        send_from_email = current_user.send_from_email.presence || current_user.email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">        # Check OAuth for current user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="11">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        oauth_configured = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="13">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          oauth_configured = GmailOauthService.oauth_configured?(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">          # If send_from_email is different and current user doesn&#39;t have OAuth,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">          # check if the send_from_email user has OAuth</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="17">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          if !oauth_configured &amp;&amp; send_from_email != current_user.email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="18">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">            email_user = User.find_by(email: send_from_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="19">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">            if email_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="20">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">              oauth_configured = GmailOauthService.oauth_configured?(email_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="21">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">              Rails.logger.info(&quot;[EmailConfig] Using OAuth from send_from_email user (#{email_user.id})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">          # If OAuth is not configured at app level, return false</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="26">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          Rails.logger.warn(&quot;Gmail OAuth service error: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="27">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          oauth_configured = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="30">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">          email: send_from_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">          oauth_configured: oauth_configured</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      # PUT /api/v1/email_config</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      # Updates user&#39;s send from email address</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def update</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="40">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        email = params[:email]&amp;.strip</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="41">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        if email.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="42">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          if current_user.update(send_from_email: email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="43">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">            send_from_email = current_user.send_from_email.presence || current_user.email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">            # Check OAuth for current user or send_from_email user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="46">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">            oauth_configured = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">            begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="48">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">              oauth_configured = GmailOauthService.oauth_configured?(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">              # If send_from_email is different and current user doesn&#39;t have OAuth,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">              # check if the send_from_email user has OAuth</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="52">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">              if !oauth_configured &amp;&amp; send_from_email != current_user.email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="53">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">                email_user = User.find_by(email: send_from_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="54">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">                if email_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="55">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">                  oauth_configured = GmailOauthService.oauth_configured?(email_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="56">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">                  Rails.logger.info(&quot;[EmailConfig] Using OAuth from send_from_email user (#{email_user.id})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">            rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="60">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">              Rails.logger.warn(&quot;Gmail OAuth service error: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="61">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">              oauth_configured = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="64">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">              email: send_from_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">              oauth_configured: oauth_configured</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="69">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">              error: current_user.errors.full_messages.join(&quot;, &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">            }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="74">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">            error: &quot;Email is required&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">          }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="aa354e341381aab578a184aafd334d042aa53d36">
  <div class="header">
    <h3>app/controllers/api/v1/leads_controller.rb</h3>
    <h4>
      <span class="green">
  93.91%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>115</b> relevant lines.
      <span class="green"><b>108</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class LeadsController &lt; BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">        # Only return leads from campaigns belonging to the current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries when accessing associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="7">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        leads = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">                    .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">                    .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="10">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        render json: LeadSerializer.serialize_collection(leads)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">        # Verify the campaign belongs to current user before creating lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="17">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        Rails.logger.info &quot; Incoming params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="18">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        campaign = current_user.campaigns.find_by(id: lead_params[:campaign_id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="19">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        unless campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="20">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Campaign not found or unauthorized&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="21">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="24">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        lead = campaign.leads.build(lead_params.except(:campaign_id))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="25">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        if lead.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: LeadSerializer.serialize(lead), status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="28">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          render json: { errors: lead.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def update</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        # Only allow updating leads from campaigns belonging to current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="35">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        lead = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">                   .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">                   .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">                   .find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="39">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        if lead &amp;&amp; lead.update(lead_params.except(:campaign_id))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="40">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          render json: LeadSerializer.serialize(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: lead ? lead.errors.full_messages : [ &quot;Not found or unauthorized&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">        # Only allow deleting leads from campaigns belonging to current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="49">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        lead = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">                   .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">                   .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">                   .find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="53">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        if lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="54">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          lead.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="55">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          head :no_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="57">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      # POST /api/v1/leads/:id/run_agents</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      # Runs all agents (SEARCH  WRITER  CRITIQUE  DESIGN) for a specific lead</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">      #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">      # In production, this runs asynchronously via background job.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      # In development/test, this runs synchronously for easier debugging.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      # Use ?async=true to force async execution, ?async=false to force sync.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="68">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def run_agents</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">        # Find lead and verify ownership</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries and eager load associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="71">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">        lead = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">                   .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">                   .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">                   .find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="76">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">        unless lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="77">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Lead not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="78">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        # Get the campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="82">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">        campaign = lead.campaign</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">        # Determine if we should run async or sync</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        # Default: async in production, sync in development/test</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="86">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">        force_async = params[:async] == &quot;true&quot; || params[:async] == true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="87">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">        force_sync = params[:async] == &quot;false&quot; || params[:async] == false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="89">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">        use_async = if force_async</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="90">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="91">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">        elsif force_sync</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="92">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">          # Default behavior: async in production, sync in development/test</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="95">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">          Rails.env.production?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="24" data-linenumber="98">
            
              <span class="hits">24</span>
            

            

            <code class="ruby">        if use_async</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">          # For async mode, allow job to be queued - the job will handle missing API keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">          # and be discarded gracefully (discard_on ArgumentError)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">          # For sync mode, validate API keys before running to provide immediate feedback</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="103">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">          unless ApiKeyService.keys_available?(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="104">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            missing_keys = ApiKeyService.missing_keys(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="105">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">              status: &quot;failed&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">              error: &quot;Missing API keys: #{missing_keys.join(&#39;, &#39;)}. Please add them in the API Keys section.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">              lead: LeadSerializer.serialize(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">            }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="110">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="114">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">        if use_async</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">          # Enqueue background job</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">          begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="117">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">            job = AgentExecutionJob.perform_later(lead.id, campaign.id, current_user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="119">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">            status: &quot;queued&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">            message: &quot;Agent execution queued successfully&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">            jobId: job.job_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">            lead: LeadSerializer.serialize(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">          }, status: :accepted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">          rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="126">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            Rails.logger.error(&quot;Failed to enqueue AgentExecutionJob: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="127">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">              status: &quot;error&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">              error: &quot;Failed to queue agent execution: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">            }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">          # Run synchronously (for development/test or when explicitly requested)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">          begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">            # Run agents using LeadAgentService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="136">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">            result = LeadAgentService.run_agents_for_lead(lead, campaign, current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">            # Check for service-level errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="139">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">            if result[:status] == &quot;failed&quot; &amp;&amp; result[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="140">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">                status: result[:status],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">                error: result[:error],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">                lead: LeadSerializer.serialize(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">              }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="145">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">            # Return success response with results</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="149">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">              status: result[:status],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">              outputs: result[:outputs],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">              lead: LeadSerializer.serialize(lead),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">              completedAgents: result[:completed_agents],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">              failedAgents: result[:failed_agents]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">            }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">          rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">            # Handle any unexpected errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="159">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">              status: &quot;error&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">              error: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">            }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">      # GET /api/v1/leads/:id/agent_outputs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">      # Returns all agent outputs for a specific lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="170">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def agent_outputs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">        # Find lead and verify ownership</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries when loading agent_outputs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="173">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        lead = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">                   .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">                   .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">                   .find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="178">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        unless lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="179">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Lead not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="180">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">        # Get all agent outputs for this lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="184">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">        outputs = lead.agent_outputs.map { |output| AgentOutputSerializer.serialize(output) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="186">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">          leadId: lead.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">          outputs: outputs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">        }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">      # POST /api/v1/leads/:id/send_email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">      # Sends email to a single lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="195">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def send_email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">        # Find lead and verify ownership</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries and eager load agent_outputs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="198">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        lead = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">                   .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">                   .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">                   .find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="203">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        unless lead</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">          render json: { errors: [ &quot;Lead not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="209">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          result = EmailSenderService.send_email_for_lead(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="211">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="212">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby">              success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">              message: result[:message]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            

            <code class="ruby">            }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">            render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">              success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby">              error: result[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">            }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="223">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">            success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="225">
            

            

            <code class="ruby">            error: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            

            <code class="ruby">          }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">      # PATCH /api/v1/leads/:id/update_agent_output</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">      # Updates a specific agent output (supports WRITER and SEARCH)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="233">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def update_agent_output</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby">        # Find lead and verify ownership</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">        # Use includes to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="236">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        lead = Lead.includes(:campaign, :agent_outputs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">                   .joins(:campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            

            <code class="ruby">                   .where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">                   .find_by(id: params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="241">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">        unless lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="242">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Lead not found or unauthorized&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="243">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="246">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">        agent_name = params[:agentName] || params[:agent_name]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="248">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">        unless agent_name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="249">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Agent name is required&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="250">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="253">
            

            

            <code class="ruby">        # Only allow updating WRITER, SEARCH, and DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="254">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        unless agent_name.in?([ AgentConstants::AGENT_WRITER, AgentConstants::AGENT_SEARCH, AgentConstants::AGENT_DESIGN ])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="255">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          render json: { errors: [ &quot;Only WRITER, SEARCH, and DESIGN agent outputs can be updated&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="256">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">        # Find the agent output</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="260">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        agent_output = lead.agent_outputs.find_by(agent_name: agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="262">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        unless agent_output</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">          render json: { errors: [ &quot;Agent output not found&quot; ] }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            

            <code class="ruby">        # Handle different agent types</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="268">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        if agent_name == AgentConstants::AGENT_WRITER</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">          # Get the new email content from params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="270">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          new_email = params[:content] || params[:email]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="272">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          unless new_email</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">            render json: { errors: [ &quot;Email content is required&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">            return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="276">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="277">
            

            

            <code class="ruby">          # Update the output data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="278">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          updated_data = agent_output.output_data.merge(email: new_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="279">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          agent_output.update!(output_data: updated_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="280">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        elsif agent_name == AgentConstants::AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            

            <code class="ruby">          # Get the new formatted email content from params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="282">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          new_email = params[:content] || params[:email] || params[:formatted_email]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="283">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="284">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          unless new_email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="285">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            render json: { errors: [ &quot;Email content is required&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="286">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="288">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="289">
            

            

            <code class="ruby">          # Update the output data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="290">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          updated_data = agent_output.output_data.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="291">
            

            

            <code class="ruby">            email: new_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="292">
            

            

            <code class="ruby">            formatted_email: new_email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="293">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="294">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          agent_output.update!(output_data: updated_data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="295">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        elsif agent_name == AgentConstants::AGENT_SEARCH</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            

            <code class="ruby">          # Get the updated data from params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="297">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          updated_data_param = params[:updatedData] || params[:updated_data]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="299">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          unless updated_data_param</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="300">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            render json: { errors: [ &quot;Updated data is required for SEARCH agent&quot; ] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="301">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="302">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby">          # Update the output data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="305">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          agent_output.update!(output_data: updated_data_param)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="307">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="308">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">        render json: AgentOutputSerializer.serialize(agent_output), status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="310">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="311">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="312">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="313">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def lead_params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby">        # Convert camelCase to snake_case for database</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="315">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">        params_hash = params.require(:lead).permit(:name, :email, :title, :company, :website, :campaignId, :stage, :quality).to_h.with_indifferent_access</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="316">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">        params_hash[:campaign_id] = params_hash.delete(:campaignId) if params_hash[:campaignId]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="317">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">        params_hash</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="321">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a149d071471fba0f4cee3dcfa82d5bf395b61d52">
  <div class="header">
    <h3>app/controllers/api/v1/oauth_statuses_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>11</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Api</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  module V1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    class OauthStatusesController &lt; BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">      ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">      # GET /api/v1/oauth_status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">      # Returns OAuth configuration status</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="8">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        client_id_present = ENV[&quot;GMAIL_CLIENT_ID&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="9">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        client_secret_present = ENV[&quot;GMAIL_CLIENT_SECRET&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="10">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        oauth_configured = client_id_present &amp;&amp; client_secret_present</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">        # Log for debugging (avoid logging sensitive values)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="13">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;OAuth Status Check - CLIENT_ID present: #{client_id_present}, CLIENT_SECRET present: #{client_secret_present}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">        status = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="16">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          oauth_configured: oauth_configured,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">          client_id_set: client_id_present,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">          client_secret_set: client_secret_present,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          message: oauth_configured ? &quot;OAuth is configured&quot; : &quot;OAuth is not configured. Missing: #{[ !client_id_present &amp;&amp; &#39;GMAIL_CLIENT_ID&#39;, !client_secret_present &amp;&amp; &#39;GMAIL_CLIENT_SECRET&#39; ].compact.join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="22">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        render json: status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="33b7f2000d863f06e2fee1b3f19f8cc8976d5742">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>33</b> relevant lines.
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Only allow modern browsers supporting webp images, web push, badges, import maps, CSS nesting, and CSS :has.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  allow_browser versions: :modern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Changes to the importmap will invalidate the etag for HTML responses</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  stale_when_importmap_changes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  DEFAULT_DEV_LLM_KEY = &quot;AIzaSyCtqoCmJ9r5zxSSYu27Kxffa5HaXDrlKvE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  DEFAULT_DEV_TAVILY_KEY = &quot;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&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # Development helper: ensure users have default API keys in development</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="263" data-linenumber="12">
            
              <span class="hits">263</span>
            

            

            <code class="ruby">  before_action :ensure_default_api_keys_for_dev, if: -&gt; { Rails.env.development? }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  # Override Devise path helpers to use custom routes in production</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def new_user_session_path(*args)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="16">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    if Rails.env.production?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &quot;/login&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      # In development, use Devise&#39;s default path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.application.routes.url_helpers.new_user_session_path(*args)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def new_user_registration_path(*args)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    if Rails.env.production?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &quot;/signup&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      # In development, use Devise&#39;s default path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.application.routes.url_helpers.new_user_registration_path(*args)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="126" data-linenumber="34">
            
              <span class="hits">126</span>
            

            

            <code class="ruby">    user = super</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="126" data-linenumber="35">
            
              <span class="hits">126</span>
            

            

            <code class="ruby">    normalize_user(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def ensure_default_api_keys_for_dev</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    # Double-check we&#39;re in development mode (safety check)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="42">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    return unless Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="44">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="45">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    return unless user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    # In development, give all users default API keys for convenience</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    # This should NEVER run in production</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="49">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    updates = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="50">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    updates[:llm_api_key] = DEFAULT_DEV_LLM_KEY if user.llm_api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="51">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    updates[:tavily_api_key] = DEFAULT_DEV_TAVILY_KEY if user.tavily_api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="53">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    return if updates.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="55">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    user.update(updates)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def normalize_user(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="427" data-linenumber="59">
            
              <span class="hits">427</span>
            

            

            <code class="ruby">    return user if user.is_a?(User) || user.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="60">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    return nil unless user.respond_to?(:[])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="62">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    user_id = user[:id] || user[&quot;id&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="63">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    return nil if user_id.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="65">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    User.find_by(id: user_id) || nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="80af6ef35649a50673bd184ec3f9420f63ed4e1e">
  <div class="header">
    <h3>app/controllers/campaigns_controller.rb</h3>
    <h4>
      <span class="green">
  97.5%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>40</b> relevant lines.
      <span class="green"><b>39</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class CampaignsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authenticate_user!, unless: :skip_auth?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="5">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">    @campaigns = current_user.campaigns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="6">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">    @leads = Lead.joins(:campaign).where(campaigns: { user_id: current_user.id })</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="7">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">    @user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="11">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    @campaign = current_user.campaigns.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    @leads = @campaign.leads</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def skip_auth?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    # Skip authentication when explicitly disabled, otherwise respect environment defaults</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="19">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    disable_auth = ENV[&quot;DISABLE_AUTH&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="20">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    return true if disable_auth == &quot;true&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="21">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    return false if disable_auth == &quot;false&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    # Default behaviour: skip in development for convenience</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # Get the authenticated user from Devise directly using warden to avoid recursion</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # warden.user accesses Devise&#39;s session directly without calling current_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="30">
            
              <span class="hits">82</span>
            

            

            <code class="ruby">    authenticated_user = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    # Try to get user from Devise&#39;s warden (bypasses our overridden current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # This is the safest way to avoid infinite recursion</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="34">
            
              <span class="hits">82</span>
            

            

            <code class="ruby">    if respond_to?(:warden) &amp;&amp; warden</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="35">
            
              <span class="hits">82</span>
            

            

            <code class="ruby">      authenticated_user = warden.user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    # Normalize the user if needed (from ApplicationController)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="39">
            
              <span class="hits">82</span>
            

            

            <code class="ruby">    authenticated_user = normalize_user(authenticated_user) if authenticated_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="40">
            
              <span class="hits">82</span>
            

            

            <code class="ruby">    authenticated_user = ensure_admin_profile!(authenticated_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    # If we have an authenticated user (from Devise session), use them</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    # This will be the case when a user has logged in, even in development</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="82" data-linenumber="44">
            
              <span class="hits">82</span>
            

            

            <code class="ruby">    return authenticated_user if authenticated_user.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # Only use admin user as fallback in development when no user is authenticated</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    # This is for convenience when testing without logging in</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="48">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    if skip_auth? &amp;&amp; authenticated_user.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      # Always use admin@example.com in development mode for testing</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="50">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      admin_user = User.find_by(email: &quot;admin@example.com&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="52">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      if admin_user.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        admin_user = User.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">          email: &quot;admin@example.com&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">          password: &quot;password123&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">          password_confirmation: &quot;password123&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">          name: &quot;Admin User&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">          first_name: &quot;Admin&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">          last_name: &quot;User&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">          workspace_name: &quot;Admin Workspace&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">          job_title: &quot;Administrator&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="65">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      admin_user = ensure_admin_profile!(admin_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="66">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      normalize_user(admin_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="68">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      authenticated_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="72">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def ensure_admin_profile!(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="85" data-linenumber="73">
            
              <span class="hits">85</span>
            

            

            <code class="ruby">    return user unless user&amp;.email == &quot;admin@example.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # Always base updates on the persisted record to avoid stale in-memory data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">    # (e.g., when tests change columns directly with `update_columns`).</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="77">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    persisted_user = User.find_by(id: user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="78">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    return user unless persisted_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="80">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    updates = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="81">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    updates[:first_name] = &quot;Admin&quot; if persisted_user.first_name.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="82">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    updates[:last_name] = &quot;User&quot; if persisted_user.last_name.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="83">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    updates[:workspace_name] = &quot;Admin Workspace&quot; if persisted_user.workspace_name.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="84">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    updates[:job_title] = &quot;Administrator&quot; if persisted_user.job_title.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="86">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    persisted_user.update!(updates) if updates.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="47" data-linenumber="87">
            
              <span class="hits">47</span>
            

            

            <code class="ruby">    persisted_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4bfc9f8b9db216c106628bdc0fd8507b37db746b">
  <div class="header">
    <h3>app/controllers/oauth_controller.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>51</b> relevant lines.
      <span class="green"><b>51</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># OauthController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Handles OAuth callbacks for Gmail/Google Workspace email authentication</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class OauthController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authenticate_user!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # GET /oauth/gmail/authorize</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # Initiates OAuth flow by redirecting to Google authorization</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def gmail_authorize</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      # Check if OAuth is configured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="15">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      unless ENV[&quot;GMAIL_CLIENT_ID&quot;].present? &amp;&amp; ENV[&quot;GMAIL_CLIENT_SECRET&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="16">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        flash[:error] = &quot;Gmail OAuth is not configured. Please set GMAIL_CLIENT_ID and GMAIL_CLIENT_SECRET environment variables.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="17">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;Gmail OAuth not configured: missing GMAIL_CLIENT_ID or GMAIL_CLIENT_SECRET&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="18">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="22">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[Gmail OAuth] Starting authorization for user #{current_user.id} (#{current_user.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="23">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      authorization_url = GmailOauthService.authorization_url(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      # Store state in session for security</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="26">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      session[:oauth_state] = SecureRandom.hex(16)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="27">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      session[:oauth_user_id] = current_user.id  # Store user ID to verify on callback</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="29">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[Gmail OAuth] Redirecting to: #{authorization_url}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="30">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      redirect_to authorization_url, allow_other_host: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      error_message = &quot;Gmail OAuth error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      flash[:error] = error_message</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;[Gmail OAuth] Authorization error: #{e.class.name} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="35">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # GET /oauth/gmail/callback</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  # Handles OAuth callback from Google</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def gmail_callback</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="44">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">    Rails.logger.info(&quot;[Gmail OAuth] Callback received for user #{current_user.id} (#{current_user.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="46">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">    if params[:error].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="47">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      error_msg = &quot;OAuth authorization failed: #{params[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="48">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;[Gmail OAuth] Callback error: #{error_msg}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="49">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      flash[:error] = error_msg</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="50">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="51">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="54">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    code = params[:code]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="55">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    unless code.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="56">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;[Gmail OAuth] No authorization code received&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="57">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      flash[:error] = &quot;No authorization code received&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="58">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="59">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">    # Verify user ID matches (security check)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="63">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    if session[:oauth_user_id].present? &amp;&amp; session[:oauth_user_id] != current_user.id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="64">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      Rails.logger.warn(&quot;[Gmail OAuth] User ID mismatch: session=#{session[:oauth_user_id]}, current=#{current_user.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="68">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[Gmail OAuth] Exchanging code for tokens for user #{current_user.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="69">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      if GmailOauthService.exchange_code_for_tokens(current_user, code)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="70">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[Gmail OAuth] Successfully configured for user #{current_user.id} (#{current_user.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">        # Clear session</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="72">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        session.delete(:oauth_state)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="73">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        session.delete(:oauth_user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="74">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        flash[:success] = &quot;Gmail OAuth successfully configured! You can now send emails.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="76">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[Gmail OAuth] Failed to exchange code for tokens for user #{current_user.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="77">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        flash[:error] = &quot;Failed to configure Gmail OAuth. Please try again.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="80">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;[Gmail OAuth] Callback exception: #{e.class} #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="81">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="82">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      flash[:error] = &quot;OAuth callback failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="85">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">  # DELETE /oauth/gmail/revoke</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">  # Revokes OAuth tokens</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="91">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def gmail_revoke</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="92">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    current_user.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      gmail_access_token: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">      gmail_refresh_token: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">      gmail_token_expires_at: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="98">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    flash[:success] = &quot;Gmail OAuth revoked successfully.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="99">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4fd8c8790733285c4716ab69553399254fc33de0">
  <div class="header">
    <h3>app/controllers/users/registrations_controller.rb</h3>
    <h4>
      <span class="yellow">
  89.58%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>48</b> relevant lines.
      <span class="green"><b>43</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Users::RegistrationsController &lt; Devise::RegistrationsController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Handle authentication check before Devise&#39;s require_no_authentication</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  prepend_before_action :check_authentication_and_remember_me, only: [ :new ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # POST /resource</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="7">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    build_resource(sign_up_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    # Combine first_name and last_name into name if provided</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="10">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    if params[:first_name].present? &amp;&amp; params[:last_name].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="11">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      resource.name = &quot;#{params[:first_name]} #{params[:last_name]}&quot;.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Set additional fields</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="15">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    resource.first_name = params[:first_name] if params[:first_name].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="16">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    resource.last_name = params[:last_name] if params[:last_name].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="17">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    resource.workspace_name = params[:workspace_name] if params[:workspace_name].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="18">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    resource.job_title = params[:job_title] if params[:job_title].present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="20">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    resource.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="21">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    yield resource if block_given?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="22">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    if resource.persisted?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="23">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      if resource.active_for_authentication?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="24">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        set_flash_message! :notice, :signed_up</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="25">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        sign_up(resource_name, resource)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="26">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        respond_with resource, location: after_sign_up_path_for(resource)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        set_flash_message! :notice, :&quot;signed_up_but_#{resource.inactive_message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        expire_data_after_sign_in!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        respond_with resource, location: after_inactive_sign_up_path_for(resource)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="33">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      clean_up_passwords resource</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="34">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      set_minimum_password_length</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="35">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      respond_with resource</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def check_authentication_and_remember_me</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    # If user is authenticated, check if they have &quot;remember me&quot; set</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="43">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">    if user_signed_in?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      # Check if user is remembered via cookie (remember_me functionality)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="45">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      if user_remembered?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        # If remembered, redirect to user page</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        redirect_to root_path and return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">        # If not remembered, sign them out and clear remember_me cookie</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        # Explicitly clear the remember_me cookie to ensure it&#39;s removed</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        cookies.delete(cookie_name, domain: :all)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        cookies.delete(cookie_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        # Clear the remember_created_at in the database</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="56">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        current_user.update_column(:remember_created_at, nil) if current_user.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        # Sign out the user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        sign_out(:user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        # Clear any flash messages about being already signed in</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="62">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        flash.delete(:alert)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">        # Redirect to signup page to ensure clean page load</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        redirect_to &quot;/signup&quot; and return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  # Check if user is remembered via Devise&#39;s remember_me cookie</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def user_remembered?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    return false unless user_signed_in?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    # Check both the cookie and the database field to ensure they&#39;re actually remembered</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    has_cookie = cookies.signed[cookie_name].present? ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">                 cookies.encrypted[cookie_name].present? ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">                 cookies[cookie_name].present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    # Also check if the user has remember_created_at set in the database</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    # This ensures the remember_me state is actually active (Devise handles expiration)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    has_db_remember = current_user.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    has_cookie &amp;&amp; has_db_remember</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="87">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def sign_up_params</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="88">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    params.require(:user).permit(:email, :password, :password_confirmation, :name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="91">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  protected</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">  # The path used after sign up</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="94">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def after_sign_up_path_for(resource)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="95">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    root_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">  # The path used after sign up for inactive accounts</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="99">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def after_inactive_sign_up_path_for(resource)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="100">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    root_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="effef0f26a95c27c3a47edf93d8f2b59479f214c">
  <div class="header">
    <h3>app/controllers/users/sessions_controller.rb</h3>
    <h4>
      <span class="green">
  96.61%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>59</b> relevant lines.
      <span class="green"><b>57</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Users::SessionsController &lt; Devise::SessionsController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Handle authentication check before Devise&#39;s require_no_authentication</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  prepend_before_action :check_authentication_and_remember_me, only: [ :new ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Store remember_me state for use in after_action</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  attr_accessor :remember_me_was_checked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Override create to ensure remember_me is properly handled</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    # Check if remember_me is actually checked (it will be &quot;1&quot; if checked, absent or &quot;0&quot; if not)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="11">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    self.remember_me_was_checked = params[:user] &amp;&amp; params[:user][:remember_me] == &quot;1&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    # Before processing login, if remember_me is not checked, clear any existing cookie</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="14">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    unless remember_me_was_checked</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="15">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="16">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name, domain: :all)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="17">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # Temporarily remove remember_me from params if not checked to prevent Devise from setting it</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="21">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    original_remember_me = nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="22">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    if params[:user] &amp;&amp; !remember_me_was_checked</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="23">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      original_remember_me = params[:user].delete(:remember_me)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="26">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    super</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # After successful login, if remember_me was not checked, ensure everything is cleared</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="29">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if user_signed_in? &amp;&amp; !remember_me_was_checked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      # Clear the database field to ensure state is consistent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="31">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      if current_user.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        current_user.update_column(:remember_created_at, nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      # Also ensure cookie is cleared (in case Devise set it somehow)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="35">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="36">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name, domain: :all)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="37">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    # Restore the param if we removed it (for potential error handling)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="41">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if original_remember_me &amp;&amp; params[:user]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="42">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      params[:user][:remember_me] = original_remember_me</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  # Override destroy (sign out) to ensure remember_me is cleared</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    # Get the user before signing out</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="49">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="51">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    super</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    # After sign out, explicitly clear remember_me cookie and database field</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="54">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    if user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="55">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="56">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name, domain: :all)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="57">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      # Clear the database field</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="60">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      if user.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        user.update_column(:remember_created_at, nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="68">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def check_authentication_and_remember_me</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    # If user is authenticated, check if they have &quot;remember me&quot; set</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="70">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    if user_signed_in?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      # Check if user is remembered via cookie (remember_me functionality)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="72">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      if user_remembered?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">        # If remembered, redirect to user page</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="74">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        redirect_to root_path and return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">        # If not remembered, sign them out and clear remember_me cookie</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">        # Explicitly clear the remember_me cookie to ensure it&#39;s removed</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="78">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="79">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        cookies.delete(cookie_name, domain: :all)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="80">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        cookies.delete(cookie_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">        # Clear the remember_created_at in the database</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="83">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        current_user.update_column(:remember_created_at, nil) if current_user.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        # Sign out the user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="86">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        sign_out(:user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        # Clear any flash messages about being already signed in</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="89">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        flash.delete(:alert)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">        # Redirect to login page to ensure clean page load</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="92">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        redirect_to &quot;/login&quot; and return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">  # Check if user is remembered via Devise&#39;s remember_me cookie</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="98">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def user_remembered?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="99">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    return false unless user_signed_in?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    # Check both the cookie and the database field to ensure they&#39;re actually remembered</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="102">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="103">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    has_cookie = cookies.signed[cookie_name].present? ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">                 cookies.encrypted[cookie_name].present? ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">                 cookies[cookie_name].present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">    # Also check if the user has remember_created_at set in the database</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">    # This ensures the remember_me state is actually active (Devise handles expiration)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="109">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    has_db_remember = current_user.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="111">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    has_cookie &amp;&amp; has_db_remember</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="114">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  protected</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">  # The path used after sign in</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="117">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def after_sign_in_path_for(resource)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">    # After sign in, if remember_me was not checked, ensure it&#39;s cleared</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="119">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if resource &amp;&amp; !remember_me_was_checked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">      # Clear the database field</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="121">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      if resource.remember_created_at.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="122">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        resource.update_column(:remember_created_at, nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      # Clear the cookie</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="125">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookie_name = &quot;remember_user_token&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="126">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name, domain: :all)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="127">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      cookies.delete(cookie_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="129">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    root_path</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">  # The path used after sign out</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="133">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def after_sign_out_path_for(resource_or_scope)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="134">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    &quot;/login&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9761d38fcf9e19cbd7dab3415880d8a0743336e1">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module ApplicationHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dd68fe0b2890bc93a2ee3a4e699b022c9182e527">
  <div class="header">
    <h3>app/helpers/markdown_helper.rb</h3>
    <h4>
      <span class="green">
  97.26%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>73</b> relevant lines.
      <span class="green"><b>71</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module MarkdownHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # Converts markdown to HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # Supports: **bold**, *italic*, ~~strikethrough~~, `code`, [links](url), &gt;quotes, bullet lists</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Removes &quot;Subject: ...&quot; lines as subject is handled separately by mailer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def markdown_to_html(text)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="7">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">    return &quot;&quot; if text.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="9">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    html = text.dup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    # Remove Subject line if present (subject is handled separately by CampaignMailer)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="12">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    html.gsub!(/^Subject:\s*.+$/i, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Split by lines to process block-level elements</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="15">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    lines = html.split(/\n/)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="16">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    result = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="17">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    in_list = false</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="18">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    current_paragraph = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="20">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    lines.each_with_index do |line, index|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="21">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      line_stripped = line.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      # Skip empty lines (they separate paragraphs)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="24">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      if line_stripped.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">        # If we have accumulated paragraph content, process it</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="26">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">        if current_paragraph.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="27">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          paragraph_text = current_paragraph.join(&quot; &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="28">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          result &lt;&lt; &quot;&lt;p&gt;#{process_inline_markdown(paragraph_text)}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="29">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          current_paragraph = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">        # End list if we hit an empty line</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="32">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">        if in_list</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="33">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          result &lt;&lt; &quot;&lt;/ul&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="34">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          in_list = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="36">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">        next</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      # Handle blockquotes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="58" data-linenumber="40">
            
              <span class="hits">58</span>
            

            

            <code class="ruby">      if line_stripped.start_with?(&quot;&gt;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        # Process any accumulated paragraph first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="42">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        if current_paragraph.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          paragraph_text = current_paragraph.join(&quot; &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          result &lt;&lt; &quot;&lt;p&gt;#{process_inline_markdown(paragraph_text)}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          current_paragraph = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="47">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        result &lt;&lt; &quot;&lt;/ul&gt;&quot; if in_list</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="48">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        in_list = false</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="49">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        quote_text = line_stripped.sub(/^&gt;\s*/, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="50">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        result &lt;&lt; &quot;&lt;blockquote&gt;#{process_inline_markdown(quote_text)}&lt;/blockquote&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="51">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        next</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      # Handle bullet lists</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="52" data-linenumber="55">
            
              <span class="hits">52</span>
            

            

            <code class="ruby">      if line_stripped.match(/^[\-\*]\s+/)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        # Process any accumulated paragraph first</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="57">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        if current_paragraph.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          paragraph_text = current_paragraph.join(&quot; &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          result &lt;&lt; &quot;&lt;p&gt;#{process_inline_markdown(paragraph_text)}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="60">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          current_paragraph = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="62">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        result &lt;&lt; &quot;&lt;ul&gt;&quot; unless in_list</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="63">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        in_list = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="64">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        list_item = line_stripped.sub(/^[\-\*]\s+/, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="65">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        result &lt;&lt; &quot;&lt;li&gt;#{process_inline_markdown(list_item)}&lt;/li&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="66">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        next</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      # End list if we hit a non-list line</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="70">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">      if in_list</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">        result &lt;&lt; &quot;&lt;/ul&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">        in_list = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      # Accumulate paragraph content (handle line breaks within paragraphs)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="76">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">      current_paragraph &lt;&lt; line_stripped</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    # Process any remaining paragraph content</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="80">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    if current_paragraph.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="81">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      paragraph_text = current_paragraph.join(&quot; &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="82">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      result &lt;&lt; &quot;&lt;p&gt;#{process_inline_markdown(paragraph_text)}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    # Close any open list</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="86">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    result &lt;&lt; &quot;&lt;/ul&gt;&quot; if in_list</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="88">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">    result.join(&quot;\n&quot;).html_safe</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="91">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">  # Processes inline markdown formatting (bold, italic, links, code, strikethrough)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="95">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def process_inline_markdown(text)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="96">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html = text.dup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    # Convert links [text](url) - must come before other formatting</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="99">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html.gsub!(/\[([^\]]+)\]\(([^\)]+)\)/, &#39;&lt;a href=&quot;\2&quot;&gt;\1&lt;/a&gt;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    # Convert code `text` - must come before bold/italic</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="102">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html.gsub!(/`([^`]+)`/, &#39;&lt;code&gt;\1&lt;/code&gt;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">    # Convert bold **text** - must come before italic</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="105">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html.gsub!(/\*\*(.+?)\*\*/, &#39;&lt;strong&gt;\1&lt;/strong&gt;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">    # Convert strikethrough ~~text~~</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="108">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html.gsub!(/~~([^~]+)~~/, &#39;&lt;del&gt;\1&lt;/del&gt;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">    # Convert italic *text* (but not **bold**)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="111">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html.gsub!(/(?&lt;!\*)\*(?!\*)([^*\s][^*]*?[^*\s]|[^*])(?&lt;!\*)\*(?!\*)/, &#39;&lt;em&gt;\1&lt;/em&gt;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="113">
            
              <span class="hits">54</span>
            

            

            <code class="ruby">    html</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="116">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  public</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">  # Converts markdown to plain text (removes all formatting)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">  # Removes &quot;Subject: ...&quot; lines as subject is handled separately by mailer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="121">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def markdown_to_text(text)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="122">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">    return &quot;&quot; if text.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="124">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text = text.dup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">    # Remove Subject line if present (subject is handled separately by CampaignMailer)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="127">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/^Subject:\s*.+$/i, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">    # Remove HTML tags if any</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="130">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/&lt;[^&gt;]+&gt;/, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">    # Remove markdown formatting</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="133">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/\*\*([^*]+)\*\*/, &#39;\1&#39;)  # bold</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="134">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/(?&lt;!\*)\*(?!\*)([^*]+?)(?&lt;!\*)\*(?!\*)/, &#39;\1&#39;)  # italic</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="135">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/~~([^~]+)~~/, &#39;\1&#39;)  # strikethrough</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="136">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/`([^`]+)`/, &#39;\1&#39;)  # code</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="137">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/\[([^\]]+)\]\([^\)]+\)/, &#39;\1&#39;)  # links</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="138">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/^&gt;\s+/, &quot;&quot;)  # blockquotes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="139">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/^[\-\*]\s+/, &quot;&quot;)  # bullet points</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">    # Clean up multiple blank lines</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="142">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.gsub!(/\n\n\n+/, &quot;\n\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="144">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    text.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef3ee4490ed5e15f882ef9e79719133120bb3b86">
  <div class="header">
    <h3>app/jobs/agent_execution_job.rb</h3>
    <h4>
      <span class="yellow">
  87.5%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>24</b> relevant lines.
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># AgentExecutionJob</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Background job for executing AI agents on leads. This prevents blocking</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># the HTTP request while agents run, which can take several seconds.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"># Usage:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">#   AgentExecutionJob.perform_later(lead_id, campaign_id, user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AgentExecutionJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # Retry configuration</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  retry_on StandardError, wait: :exponentially_longer, attempts: 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # Don&#39;t retry on these errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  discard_on ArgumentError # Missing API keys, invalid parameters</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  # Executes agents for a lead in the background</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  # @param lead_id [Integer] The ID of the lead to process</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  # @param campaign_id [Integer] The ID of the campaign containing agent configs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  # @param user_id [Integer] The ID of the user (for API keys)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="25">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def perform(lead_id, campaign_id, user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # Reload records to ensure we have fresh data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="27">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    lead = Lead.find_by(id: lead_id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="28">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    campaign = Campaign.find_by(id: campaign_id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="29">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    user = User.find_by(id: user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # Verify ownership (security check)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="32">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    unless campaign &amp;&amp; campaign.user_id == user_id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="33">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;AgentExecutionJob: Unauthorized access attempt - campaign #{campaign_id} does not belong to user #{user_id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="34">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="37">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    unless lead &amp;&amp; lead.campaign_id == campaign.id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;AgentExecutionJob: Lead #{lead_id} does not belong to campaign #{campaign_id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    # Reload user to ensure we have fresh data</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="43">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    user = User.find(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    # Check API keys before running agents - raise ArgumentError if missing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # This will cause the job to be discarded (discard_on ArgumentError)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="47">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    ApiKeyService.get_gemini_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="48">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    ApiKeyService.get_tavily_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    # Execute agents</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="52">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      result = LeadAgentService.run_agents_for_lead(lead, campaign, user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      # Log the result</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="55">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      if result[:status] == &quot;failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="56">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.warn(&quot;AgentExecutionJob: Agent execution failed for lead #{lead_id}: #{result[:error]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="58">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;AgentExecutionJob: Successfully executed agents for lead #{lead_id}. Completed: #{result[:completed_agents]}, Failed: #{result[:failed_agents]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      Rails.logger.error(&quot;AgentExecutionJob: Unexpected error processing lead #{lead_id}: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      Rails.logger.error(e.backtrace.join(&quot;\n&quot;))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      raise # Re-raise to trigger retry mechanism</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="511aa129cfc56e56e2128835cc1fdcab0d4ad7a2">
  <div class="header">
    <h3>app/jobs/application_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationJob &lt; ActiveJob::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Automatically retry jobs that encountered a deadlock</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # retry_on ActiveRecord::Deadlocked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Most jobs are safe to ignore if the underlying records are no longer available</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # discard_on ActiveJob::DeserializationError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8d47a033a2a92a676db8f13a85acd465c8aa5e53">
  <div class="header">
    <h3>app/lib/custom_failure_app.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>9</b> relevant lines.
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># Custom failure app for Devise to redirect to custom routes in production</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class CustomFailureApp &lt; Devise::FailureApp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def redirect_url</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="4">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    if Rails.env.production?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">      # Use custom routes in production</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="6">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      if warden_options[:scope] == :user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">        # Check if the request was for signup</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="8">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        if request.path == &quot;/users/sign_up&quot; || request.path == &quot;/signup&quot; ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">           request.referer&amp;.include?(&quot;/signup&quot;) || request.referer&amp;.include?(&quot;/users/sign_up&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          &quot;/signup&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="12">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          &quot;/login&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        super</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      # Use default Devise routes in development</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="19">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      super</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8d2edefc653bcda077ae63b67427bd365abe6894">
  <div class="header">
    <h3>app/mailers/application_mailer.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationMailer &lt; ActionMailer::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  default from: ENV.fetch(&quot;MAILER_FROM&quot;, &quot;campaignsaastester@gmail.com&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  layout &quot;mailer&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  helper MarkdownHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b059d99df1459677cbeae70bc5746652b5ea7391">
  <div class="header">
    <h3>app/mailers/campaign_mailer.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>12</b> relevant lines.
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class CampaignMailer &lt; ApplicationMailer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # Delivers a campaign email to a single lead.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # @param to [String] recipient email address</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # @param recipient_name [String] recipient name (optional, used in templates)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # @param email_content [String] HTML/markdown content generated by agents</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # @param campaign_title [String] campaign title used for subject line context</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def send_email(to:, recipient_name:, email_content:, campaign_title:, from_email: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="10">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    @recipient_name = recipient_name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="11">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    @campaign_title = campaign_title</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="12">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    @email_content = email_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="14">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    mail(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      to: to,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      from: from_email.presence || ApplicationMailer.default[:from],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      subject: build_subject(campaign_title, recipient_name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def build_subject(campaign_title, recipient_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="24">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    base = campaign_title.presence || &quot;Campaign Outreach&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="25">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">    if recipient_name.present? &amp;&amp; recipient_name.strip.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="26">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      &quot;#{base}  Outreach for #{recipient_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      &quot;#{base}  Outreach Update&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8c185821126815c935f5d79a1a896b0e851041a1">
  <div class="header">
    <h3>app/models/agent_config.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>23</b> relevant lines.
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AgentConfig &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  include AgentConstants</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  include JsonbValidator</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :campaign</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # Validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :campaign_id, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :agent_name, presence: true, inclusion: { in: VALID_AGENT_NAMES }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # Allow empty hash for settings (SEARCH and CRITIQUE have no settings yet)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :settings, exclusion: { in: [ nil ] } # Allow empty hash, but not nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :enabled, inclusion: { in: [ true, false ] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  # Simple validation: settings must be a JSON object (Hash) when present</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  # Allow empty hash, nested objects, and arrays - no deep type enforcement</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validate :settings_must_be_json_object</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def settings_must_be_json_object</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # Allow nil or empty settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="133" data-linenumber="22">
            
              <span class="hits">133</span>
            

            

            <code class="ruby">    return if settings.nil? || settings == {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    # Top-level must be a Hash (JSON object)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="57" data-linenumber="25">
            
              <span class="hits">57</span>
            

            

            <code class="ruby">    unless settings.is_a?(Hash)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="26">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      errors.add(:settings, &quot;must be a JSON object&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # Do NOT add restrictions on nested values here.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # Arrays and hashes inside `settings` are fine.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # We only validate that the top-level is a Hash, not the contents.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  public</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  # Status query methods</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def enabled?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="38">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    enabled == true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def disabled?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="42">
            
              <span class="hits">78</span>
            

            

            <code class="ruby">    enabled == false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  # Safe accessor methods for JSONB settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def get_setting(key)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="47">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    settings[key.to_s] || settings[key.to_sym]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_setting(key, value)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="51">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    self.settings = settings.merge(key.to_s =&gt; value)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f424c27e828cb8b2e7a8aea8b7b57da6afa1da4c">
  <div class="header">
    <h3>app/models/agent_output.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>15</b> relevant lines.
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AgentOutput &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  include AgentConstants</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  include JsonbValidator</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :lead</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # Validations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :lead_id, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :agent_name, presence: true, inclusion: { in: VALID_AGENT_NAMES }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :status, presence: true, inclusion: { in: VALID_STATUSES }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :output_data, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # JSON schema validation for output_data (optional, won&#39;t break existing data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  # This provides basic structure validation without being too strict</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  # Note: Only validates properties that exist - allows flexible data structures</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates_jsonb_schema :output_data, schema: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    type: &quot;object&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    properties: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      email: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      formatted_email: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      company: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      recipient: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      sources: { type: &quot;array&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      domain: { type: &quot;object&quot; },  # SEARCH agent output (nested object)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      critique: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      score: { type: &quot;integer&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">      variants: { type: &quot;array&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      selected_variant: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      error: { type: &quot;string&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      image: { type: &quot;string&quot; },  # SEARCH agent may return image URL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      product_info: { type: &quot;string&quot; },  # WRITER agent output</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">      sender_company: { type: &quot;string&quot; }  # WRITER agent output</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  }, allow_empty: false, strict: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  # Status query methods</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def completed?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="38">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    status == STATUS_COMPLETED</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def failed?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="42">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    status == STATUS_FAILED</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def pending?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="46">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    status == STATUS_PENDING</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="52de9283f8876bebe1a6f09646894b4030fb7bfd">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  primary_abstract_class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f93af2e26f9786cfcb1aa3f3ae8a0b238c45d286">
  <div class="header">
    <h3>app/models/campaign.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>21</b> relevant lines.
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Campaign &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :leads, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :agent_configs, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Default shared_settings structure</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  after_initialize :set_default_shared_settings, if: :new_record?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # Helper methods for shared_settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def shared_settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="13">
            
              <span class="hits">49</span>
            

            

            <code class="ruby">    value = read_attribute(:shared_settings)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="14">
            
              <span class="hits">49</span>
            

            

            <code class="ruby">    if value.nil? || (value.is_a?(Hash) &amp;&amp; value.empty?)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="16">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">        &quot;brand_voice&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">          &quot;tone&quot; =&gt; &quot;professional&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">          &quot;persona&quot; =&gt; &quot;founder&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">        &quot;primary_goal&quot; =&gt; &quot;book_call&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="23">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">      value</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def brand_voice</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="28">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    shared_settings.dig(&quot;brand_voice&quot;) || {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      &quot;tone&quot; =&gt; &quot;professional&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      &quot;persona&quot; =&gt; &quot;founder&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def primary_goal</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="35">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    shared_settings[&quot;primary_goal&quot;] || &quot;book_call&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_default_shared_settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="250" data-linenumber="41">
            
              <span class="hits">250</span>
            

            

            <code class="ruby">    return if persisted? # Don&#39;t set defaults for existing records</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="250" data-linenumber="43">
            
              <span class="hits">250</span>
            

            

            <code class="ruby">    current_value = read_attribute(:shared_settings)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="250" data-linenumber="44">
            
              <span class="hits">250</span>
            

            

            <code class="ruby">    if current_value.nil? || (current_value.is_a?(Hash) &amp;&amp; current_value.empty?)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="45">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">      self.shared_settings = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        &quot;brand_voice&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">          &quot;tone&quot; =&gt; &quot;professional&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">          &quot;persona&quot; =&gt; &quot;founder&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        &quot;primary_goal&quot; =&gt; &quot;book_call&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ff3a5aec398ad0d0fc9c850f8f632c67504d1592">
  <div class="header">
    <h3>app/models/concerns/agent_constants.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>18</b> relevant lines.
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># AgentConstants</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Centralized constants for agent names and statuses to avoid magic strings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># throughout the codebase.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module AgentConstants</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Agent types</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  AGENT_SEARCH = &quot;SEARCH&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  AGENT_WRITER = &quot;WRITER&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  AGENT_CRITIQUE = &quot;CRITIQUE&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  AGENT_DESIGN = &quot;DESIGN&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  # All valid agent names</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  VALID_AGENT_NAMES = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    AGENT_SEARCH,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    AGENT_WRITER,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    AGENT_CRITIQUE,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  # Agent execution order</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  AGENT_ORDER = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    AGENT_SEARCH,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    AGENT_WRITER,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    AGENT_CRITIQUE,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # Agent output statuses</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STATUS_PENDING = &quot;pending&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STATUS_COMPLETED = &quot;completed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STATUS_FAILED = &quot;failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  # All valid statuses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  VALID_STATUSES = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    STATUS_PENDING,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    STATUS_COMPLETED,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    STATUS_FAILED</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">  ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  # Lead stages (for stage progression)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STAGE_QUEUED = &quot;queued&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STAGE_SEARCHED = &quot;searched&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STAGE_WRITTEN = &quot;written&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STAGE_CRITIQUED = &quot;critiqued&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STAGE_DESIGNED = &quot;designed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  STAGE_COMPLETED = &quot;completed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  # Stage progression order</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  STAGE_PROGRESSION = [</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    STAGE_QUEUED,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    STAGE_SEARCHED,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    STAGE_WRITTEN,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    STAGE_CRITIQUED,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    STAGE_DESIGNED,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    STAGE_COMPLETED</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">  ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7deed286d3944e0e593bb7c65c68961ec3992393">
  <div class="header">
    <h3>app/models/concerns/jsonb_validator.rb</h3>
    <h4>
      <span class="green">
  97.5%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>40</b> relevant lines.
      <span class="green"><b>39</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># JsonbValidator</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Provides JSON schema validation for JSONB fields in ActiveRecord models.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># This helps ensure data integrity for complex JSON structures stored in the database.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"># Usage:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">#   class MyModel &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#     include JsonbValidator</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">#     validates_jsonb_schema :settings, schema: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">#       type: &quot;object&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">#       properties: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">#         key: { type: &quot;string&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">#       }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">#     }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">#   end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module JsonbValidator</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  extend ActiveSupport::Concern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class_methods do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    # Validates a JSONB attribute against a JSON schema</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    # @param attribute [Symbol] The name of the JSONB attribute to validate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # @param schema [Hash] The JSON schema definition</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # @param options [Hash] Additional validation options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    #   - allow_empty: Allow empty hash/array (default: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    #   - strict: Enforce strict schema validation (default: false)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def validates_jsonb_schema(attribute, schema:, allow_empty: true, strict: false)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="31">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      validate do |record|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="214" data-linenumber="32">
            
              <span class="hits">214</span>
            

            

            <code class="ruby">        value = record.read_attribute(attribute)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">        # Skip validation if value is nil (handled by presence validations)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="214" data-linenumber="35">
            
              <span class="hits">214</span>
            

            

            <code class="ruby">        next if value.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">        # Allow empty hash/array if configured (default: true)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="214" data-linenumber="38">
            
              <span class="hits">214</span>
            

            

            <code class="ruby">        if allow_empty</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">          # Check if value is empty (works for both Hash and Array, handles both string and symbol keys)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="40">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          if (value.is_a?(Hash) &amp;&amp; value.empty?) || (value.is_a?(Array) &amp;&amp; value.empty?)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="41">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">            next</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        # Basic type checking</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="211" data-linenumber="46">
            
              <span class="hits">211</span>
            

            

            <code class="ruby">        schema_type = schema[:type] || schema[&quot;type&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="211" data-linenumber="47">
            
              <span class="hits">211</span>
            

            

            <code class="ruby">        if schema_type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="211" data-linenumber="48">
            
              <span class="hits">211</span>
            

            

            <code class="ruby">          case schema_type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">          when &quot;object&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="210" data-linenumber="50">
            
              <span class="hits">210</span>
            

            

            <code class="ruby">            unless value.is_a?(Hash)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              record.errors.add(attribute, &quot;must be an object&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              next</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">            # Validate required properties if specified</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="209" data-linenumber="56">
            
              <span class="hits">209</span>
            

            

            <code class="ruby">            if strict &amp;&amp; schema[:required]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              missing = schema[:required] - value.keys.map(&amp;:to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              if missing.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                record.errors.add(attribute, &quot;missing required properties: #{missing.join(&#39;, &#39;)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">            # Validate property types if specified</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">            # Only validate properties that actually exist in the data (flexible schema)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="209" data-linenumber="65">
            
              <span class="hits">209</span>
            

            

            <code class="ruby">            if schema[:properties]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="206" data-linenumber="66">
            
              <span class="hits">206</span>
            

            

            <code class="ruby">              schema[:properties].each do |prop_name, prop_schema|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2875" data-linenumber="67">
            
              <span class="hits">2875</span>
            

            

            <code class="ruby">                prop_key = prop_name.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2875" data-linenumber="68">
            
              <span class="hits">2875</span>
            

            

            <code class="ruby">                prop_value = value[prop_key] || value[prop_key.to_sym]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">                # Skip nil values (optional by default) - only validate if property exists</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2875" data-linenumber="71">
            
              <span class="hits">2875</span>
            

            

            <code class="ruby">                next if prop_value.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="350" data-linenumber="73">
            
              <span class="hits">350</span>
            

            

            <code class="ruby">                prop_type = prop_schema[:type] || prop_schema[&quot;type&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="350" data-linenumber="74">
            
              <span class="hits">350</span>
            

            

            <code class="ruby">                if prop_type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="350" data-linenumber="75">
            
              <span class="hits">350</span>
            

            

            <code class="ruby">                  case prop_type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">                  when &quot;string&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">                    # Allow numbers and other types to be converted to string</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="264" data-linenumber="78">
            
              <span class="hits">264</span>
            

            

            <code class="ruby">                    unless prop_value.is_a?(String) || prop_value.respond_to?(:to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">                      record.errors.add(attribute, &quot;#{prop_key} must be a string or convertible to string&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">                  when &quot;integer&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">                    # Allow strings that can be converted to integer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="83">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">                    unless prop_value.is_a?(Integer) || (prop_value.is_a?(String) &amp;&amp; prop_value.match?(/^\d+$/))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="84">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                      record.errors.add(attribute, &quot;#{prop_key} must be an integer&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">                  when &quot;boolean&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="87">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                    unless [ true, false ].include?(prop_value)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="88">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                      record.errors.add(attribute, &quot;#{prop_key} must be a boolean&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">                  when &quot;array&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="91">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">                    unless prop_value.is_a?(Array)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="92">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                      record.errors.add(attribute, &quot;#{prop_key} must be an array&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">                  when &quot;object&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">                    # Object type means Hash - allow nested objects</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="96">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">                    unless prop_value.is_a?(Hash)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="97">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">                      record.errors.add(attribute, &quot;#{prop_key} must be an object (Hash)&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">                  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">          when &quot;array&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="105">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            unless value.is_a?(Array)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="106">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">              record.errors.add(attribute, &quot;must be an array&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5052f3936865bf66478b11b4aeb6eba8b4897aa5">
  <div class="header">
    <h3>app/models/lead.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>9</b> relevant lines.
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Lead &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :agent_outputs, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :name, :email, :title, :company, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :email, format: { with: URI::MailTo::EMAIL_REGEXP }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_save :set_default_website</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_default_website</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="396" data-linenumber="13">
            
              <span class="hits">396</span>
            

            

            <code class="ruby">    self.website = email.split(&quot;@&quot;)[1] if website.to_s.strip.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c22a560aed2802b343eb077ccd1d8e207434cae1">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>5</b> relevant lines.
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class User &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Include default devise modules. Others available are:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # :confirmable, :lockable, :timeoutable, :trackable and :omniauthable</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  devise :database_authenticatable, :registerable,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">         :recoverable, :rememberable, :validatable</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :campaigns, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.serialize_from_session(*args)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="17" data-linenumber="10">
            
              <span class="hits">17</span>
            

            

            <code class="ruby">    super(*args.take(2))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="97547017f4b3c6751a1513cd7cb1c8aecec1ab41">
  <div class="header">
    <h3>app/serializers/agent_config_serializer.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>3</b> relevant lines.
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># AgentConfigSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Serializes AgentConfig model to camelCase JSON format for API responses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AgentConfigSerializer &lt; BaseSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def as_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="9">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      &quot;id&quot; =&gt; @object.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      &quot;agentName&quot; =&gt; @object.agent_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      &quot;enabled&quot; =&gt; @object.enabled,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      &quot;settings&quot; =&gt; @object.settings,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      &quot;createdAt&quot; =&gt; @object.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      &quot;updatedAt&quot; =&gt; @object.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6cc7790edbfba55456ddfd243e471d6636babfdb">
  <div class="header">
    <h3>app/serializers/agent_output_serializer.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>3</b> relevant lines.
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># AgentOutputSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Serializes AgentOutput model to camelCase JSON format for API responses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class AgentOutputSerializer &lt; BaseSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def as_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="9">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">      &quot;agentName&quot; =&gt; @object.agent_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      &quot;status&quot; =&gt; @object.status,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      &quot;outputData&quot; =&gt; @object.output_data,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      &quot;errorMessage&quot; =&gt; @object.error_message,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      &quot;createdAt&quot; =&gt; @object.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      &quot;updatedAt&quot; =&gt; @object.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d5f2ef33df5dc8787e909835786bb3755081c942">
  <div class="header">
    <h3>app/serializers/base_serializer.rb</h3>
    <h4>
      <span class="red">
  61.11%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>18</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># BaseSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Base class for all serializers. Provides camelCase conversion for simple JSON objects.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># This outputs plain JSON (not JSON:API format) to match frontend expectations.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class BaseSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Serialize a single object to camelCase JSON</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # @param object [Object] The object to serialize</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  # @param options [Hash] Additional options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # @return [Hash] Serialized object in camelCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.serialize(object, options = {})</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="58" data-linenumber="15">
            
              <span class="hits">58</span>
            

            

            <code class="ruby">    new(object, options).as_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # Serialize a collection of objects to camelCase JSON array</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  # @param collection [Array] Collection of objects to serialize</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  # @param options [Hash] Additional options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  # @return [Array] Array of serialized objects in camelCase</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.serialize_collection(collection, options = {})</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="25">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">    collection.map { |object| new(object, options).as_json }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def initialize(object, options = {})</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="29">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">    @object = object</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="64" data-linenumber="30">
            
              <span class="hits">64</span>
            

            

            <code class="ruby">    @options = options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  # Convert snake_case keys to camelCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  # @param hash [Hash] Hash with snake_case keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  # @return [Hash] Hash with camelCase keys</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def camelize_keys(hash)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    return hash unless hash.is_a?(Hash)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    hash.transform_keys { |key| camelize_key(key) }.transform_values do |value|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      case value</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      when Hash</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        camelize_keys(value)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      when Array</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">        value.map { |item| item.is_a?(Hash) ? camelize_keys(item) : item }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        value</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  # Convert a single key from snake_case to camelCase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">  # @param key [String, Symbol] The key to convert</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">  # @return [String] The camelCase key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="60">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def camelize_key(key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    key.to_s.split(&quot;_&quot;).map.with_index { |part, i| i.zero? ? part : part.capitalize }.join</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5033a43e0d64a16aee56cc0b1a44e49f4daef39d">
  <div class="header">
    <h3>app/serializers/campaign_serializer.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>3</b> relevant lines.
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># CampaignSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Serializes Campaign model to camelCase JSON format for API responses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class CampaignSerializer &lt; BaseSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def as_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="9">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      &quot;id&quot; =&gt; @object.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      &quot;title&quot; =&gt; @object.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      &quot;sharedSettings&quot; =&gt; @object.shared_settings,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      &quot;createdAt&quot; =&gt; @object.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      &quot;updatedAt&quot; =&gt; @object.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="12d0eeb791adc55b9e0fafa4cb37253bd8a9d20d">
  <div class="header">
    <h3>app/serializers/lead_serializer.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>3</b> relevant lines.
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># LeadSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Serializes Lead model to camelCase JSON format for API responses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class LeadSerializer &lt; BaseSerializer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def as_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="9">
            
              <span class="hits">31</span>
            

            

            <code class="ruby">      &quot;id&quot; =&gt; @object.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      &quot;name&quot; =&gt; @object.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      &quot;email&quot; =&gt; @object.email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      &quot;title&quot; =&gt; @object.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      &quot;company&quot; =&gt; @object.company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      &quot;website&quot; =&gt; @object.website,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      &quot;campaignId&quot; =&gt; @object.campaign_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      &quot;stage&quot; =&gt; @object.stage,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      &quot;quality&quot; =&gt; @object.quality,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      &quot;createdAt&quot; =&gt; @object.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      &quot;updatedAt&quot; =&gt; @object.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d4b328b2dc1e5ae19f0a1b53846a6edb8a44df6d">
  <div class="header">
    <h3>app/services/agents/critique_agent.rb</h3>
    <h4>
      <span class="green">
  97.22%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>72</b> relevant lines.
      <span class="green"><b>70</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;httparty&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;date&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;uri&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Agents</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # CritiqueAgent integrates with the Gemini API to read through the email (title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # email content, and number of revisions) and provide a 150-word-max critique of the email.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # @return The 150-word-max critique of the email in HTML format, in the format</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  # of json output</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class CritiqueAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    include HTTParty</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    base_uri &quot;https://generativelanguage.googleapis.com/v1beta&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    # Initialize the CritiqueAgent with API key and model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize(api_key:, model: &quot;gemini-2.5-flash&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="18">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @api_key = api_key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="19">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @model = model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="20">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @headers = { &quot;Content-Type&quot; =&gt; &quot;application/json&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="21">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Gemini API key is required&quot; if @api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    # Provide critique for the given article (title, email content, and number of</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    # revisions)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # @param article [Hash] Contains email_content, variants (optional), and number_of_revisions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # @param config [Hash, nil] Agent configuration with settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def critique(article, config: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      # Get settings from config or use defaults</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="30">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      settings = config&amp;.dig(&quot;settings&quot;) || config&amp;.dig(:settings) || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="31">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      checks = settings[&quot;checks&quot;] || settings[:checks] || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="32">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      check_personalization = checks[&quot;check_personalization&quot;] != false # Default true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="33">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      check_brand_voice = checks[&quot;check_brand_voice&quot;] != false # Default true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="34">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      check_spamminess = checks[&quot;check_spamminess&quot;] != false # Default true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="35">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      strictness = settings[&quot;strictness&quot;] || settings[:strictness] || &quot;moderate&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="36">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      min_score = (settings[&quot;min_score_for_send&quot;] || settings[:min_score_for_send] || 6).to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="37">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      rewrite_policy = settings[&quot;rewrite_policy&quot;] || settings[:rewrite_policy] || &quot;rewrite_if_bad&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="38">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      variant_selection = settings[&quot;variant_selection&quot;] || settings[:variant_selection] || &quot;highest_overall_score&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      # Handle variants if present</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="41">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      variants = article[&quot;variants&quot;] || article[:variants] || []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="42">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      email_content = article[&quot;email_content&quot;].to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      # If we have variants, critique all of them and select the best one</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="45">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      if variants.any? &amp;&amp; variant_selection != &quot;none&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="46">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        return critique_and_select_variant(variants, config, variant_selection, min_score, rewrite_policy)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        # Build critique prompt based on settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="51">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        strictness_guidance = case strictness</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">        when &quot;lenient&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          &quot;Be lenient - only flag extreme issues. Focus on major problems that would significantly impact email effectiveness.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        when &quot;moderate&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="55">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">          &quot;Enforce basic quality &amp; tone standards. Flag issues that would reduce email effectiveness or professionalism.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        when &quot;strict&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          &quot;Be strict - require strong personalization &amp; adherence to best practices. Flag any issues that could be improved.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">          &quot;Enforce basic quality &amp; tone standards.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="62">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        checks_list = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="63">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        checks_list &lt;&lt; &quot;Personalization: Check if the email shows research and personalization appropriate for the recipient and company.&quot; if check_personalization</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="64">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        checks_list &lt;&lt; &quot;Brand Voice: Verify the tone and style match the intended brand voice and persona.&quot; if check_brand_voice</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="65">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        checks_list &lt;&lt; &quot;Spamminess: Identify spam-trigger words, excessive promotional language, or patterns that could hurt deliverability.&quot; if check_spamminess</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="67">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        model_content = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">      Today&#39;s date is #{Date.today.strftime(&quot;%d/%m/%Y&quot;)}. You are the Critique Agent in a multi-agent workflow that evaluates and provides structured feedback on marketing email drafts from the user.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      Your goal is to assess the quality of an email using objective and quantitative criteria across five dimensions:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      1. Readability &amp; Clarity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      2. Engagement &amp; Persuasion</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">      3. Structural &amp; Stylistic Quality</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      4. Brand Alignment &amp; Tone Consistency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">      5. Deliverability &amp; Technical Health</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      You must output string:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">      - If the email is strong and requires no improvement, return exactly: None</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">      - Otherwise, output constructive, actionable feedback (under 150 words) explaining how to improve the email. Write professionally and concisely, focusing on what can be changed.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">      Strictness Level: #{strictness_guidance}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">      Minimum Score for Send: #{min_score}/10. If the email scores below #{min_score}, provide feedback to improve it.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="66" data-linenumber="92">
            
              <span class="hits">66</span>
            

            

            <code class="ruby">      #{checks_list.any? ? &quot;Focus Areas:\n#{checks_list.map { |c| &quot;- #{c}&quot; }.join(&quot;\n&quot;)}\n\n&quot; : &quot;&quot;}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">      Use the following criteria for your evaluation and feedback formulation:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      1. Readability &amp; Clarity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">      - Estimate readability (Flesch Reading Ease) and grade level.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      - Check sentence length, simplicity, and passive voice.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">      - Aim for clear, conversational tone (grade 6-8 level).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      2. Engagement &amp; Persuasion</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      - Assess tone and energy.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">      - Evaluate quality and placement of Calls-To-Action (CTAs).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">      - Reward positive sentiment and natural persuasive words.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      3. Structure &amp; Style</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">      - Check logical flow: subject  body  CTA.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      - Prefer short paragraphs and clean formatting.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">      4. Brand &amp; Tone Consistency</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">      - Ensure tone matches intent (friendly, professional, confident, etc.).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">      5. Deliverability</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      - Penalize spam-trigger words or excessive links.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">      - Reward clean, trustworthy, text-focused content.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      Use the critique framework described above to evaluate the following marketing email draft:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">      PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="131">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        response = self.class.post(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">            &quot;/models/#{@model}:generateContent?key=#{@api_key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">            headers: @headers,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">            body: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">            contents: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">                { role: &quot;model&quot;, parts: [ { text: model_content } ] },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">                { role: &quot;user&quot;, parts: [ { text: email_content } ] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">            }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">      rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="142">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        warn &quot;CritiqueAgent network error: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="143">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        return { &quot;critique&quot; =&gt; nil, &quot;error&quot; =&gt; &quot;Network error&quot;, &quot;detail&quot; =&gt; e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="146">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      parsed = response.parsed_response</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="147">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      text = parsed.dig(&quot;candidates&quot;, 0, &quot;content&quot;, &quot;parts&quot;, 0, &quot;text&quot;).to_s.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="149">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      number_of_revisions = article[&quot;number_of_revisions&quot;] || article[:number_of_revisions]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="150">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      revision_count = number_of_revisions.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">      # Extract score from critique if present (look for patterns like &quot;Score: 7/10&quot; or &quot;7/10&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="153">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      score = extract_score_from_critique(text, min_score)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      # If the number of revisions reaches the max allowed attempts (3) we stop critiquing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      # to avoid infinite loops. Also, if the critique is &quot;None&quot;, we return nil critique.</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="157">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      if text.casecmp(&quot;none&quot;).zero? || revision_count &gt;= 3</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="158">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        return { &quot;critique&quot; =&gt; nil, &quot;score&quot; =&gt; 10, &quot;meets_min_score&quot; =&gt; true }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">      # Check if email meets minimum score requirement</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="162">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">      meets_min_score = score &gt;= min_score</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="164">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">      if text.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="165">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">        { &quot;critique&quot; =&gt; nil, &quot;score&quot; =&gt; score, &quot;meets_min_score&quot; =&gt; meets_min_score }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="167">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        { &quot;critique&quot; =&gt; text, &quot;score&quot; =&gt; score, &quot;meets_min_score&quot; =&gt; meets_min_score }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="171">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def run(article, config: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="172">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      result = critique(article, config: config)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="173">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      article.merge!(result)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="174">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">      article</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="177">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">    # Critiques all variants and selects the best one based on variant_selection</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="180">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def critique_and_select_variant(variants, config, variant_selection, min_score, rewrite_policy)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="181">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      critiques = variants.map.with_index do |variant, index|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">        article = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="183">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          &quot;email_content&quot; =&gt; variant,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">          &quot;number_of_revisions&quot; =&gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="186">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">        critique_result = critique(article, config: config)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="188">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">          variant_index: index,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">          variant: variant,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">          critique: critique_result[&quot;critique&quot;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">          score: critique_result[&quot;score&quot;] || 5,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">          meets_min_score: critique_result[&quot;meets_min_score&quot;] || false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">      # Select best variant based on variant_selection strategy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="197">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      selected = case variant_selection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">      when &quot;highest_personalization_score&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">        # Find variant with highest personalization (prioritize variants with no critique or lowest critique length)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="200">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        critiques.max_by { |c| c[:score] * 2 + (c[:critique].nil? ? 10 : -c[:critique].length) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">      else # &quot;highest_overall_score&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">        # Find variant with highest overall score</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="203">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        critiques.max_by { |c| c[:score] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="207">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        &quot;critique&quot; =&gt; selected[:critique],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">        &quot;score&quot; =&gt; selected[:score],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">        &quot;meets_min_score&quot; =&gt; selected[:meets_min_score],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">        &quot;selected_variant_index&quot; =&gt; selected[:variant_index],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">        &quot;selected_variant&quot; =&gt; selected[:variant],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            

            <code class="ruby">        &quot;all_variants_critiques&quot; =&gt; critiques</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby">    # Extracts a score from critique text (looks for patterns like &quot;Score: 7/10&quot; or &quot;7/10&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="217">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def extract_score_from_critique(critique_text, default_score)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="218">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">      return default_score if critique_text.nil? || critique_text.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">      # Look for score patterns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="221">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      score_match = critique_text.match(/(?:score|rating|quality)[:\s]*(\d+)\s*\/?\s*10/i)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="222">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      return score_match[1].to_i if score_match</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">      # If critique is &quot;None&quot;, assume high score</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="225">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      return 10 if critique_text.casecmp(&quot;none&quot;).zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby">      # Default: if critique exists, assume it needs improvement (lower score)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">      # If no critique, assume it&#39;s good (higher score)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">      critique_text.strip.empty? ? 8 : 5</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="741e1d5ebff4760a77f743feb2223f7835b4eede">
  <div class="header">
    <h3>app/services/agents/design_agent.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>69</b> relevant lines.
      <span class="green"><b>69</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;httparty&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">=begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">DESIGN AGENT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">OVERVIEW:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">The DesignAgent uses Google&#39;s Gemini AI to apply formatting (bold, italic) to email content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">generated by the WriterAgent. It enhances the email with visual emphasis to improve readability</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">and engagement.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">HOW IT WORKS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">1. Receives email content from WriterAgent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">2. Analyzes the content to identify key phrases, important points, and emphasis opportunities</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">3. Applies bold formatting to key terms, company names, and important concepts</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">4. Applies italic formatting to quotes, emphasis, and subtle highlights</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">5. Returns formatted email with HTML or markdown formatting</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">INPUT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">writer_output:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    email: &quot;Subject: ...\n\nHi John,\n...&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    company: &quot;Microsoft&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    recipient: &quot;John Doe&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">OUTPUT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">{</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  email: &quot;Subject: ...\n\nHi **John**,\n...&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  formatted_email: &quot;&lt;strong&gt;...&lt;/strong&gt; or **...**&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  company: &quot;Microsoft&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  recipient: &quot;John Doe&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">KEY FEATURES:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">- Applies bold formatting to important terms, company names, and key concepts</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">- Applies italic formatting for emphasis and quotes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">- Maintains email structure and readability</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">- Preserves original content intent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">=end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Agents</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class DesignAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    include HTTParty</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    base_uri &quot;https://generativelanguage.googleapis.com/v1beta&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize(api_key:, model: &quot;gemini-2.5-flash&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="48">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">      @api_key = api_key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="49">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">      @model = model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="50">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Gemini API key is required&quot; if @api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def run(writer_output, config: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="54">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      email_content = writer_output[:email] || writer_output[&quot;email&quot;] || &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="55">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      company = writer_output[:company] || writer_output[&quot;company&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="56">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      recipient = writer_output[:recipient] || writer_output[&quot;recipient&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      # Extract settings from config (handle both camelCase and snake_case)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="59">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      settings = config&amp;.dig(:settings) || config&amp;.dig(&quot;settings&quot;) || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="60">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      format = settings[:format] || settings[&quot;format&quot;] || &quot;formatted&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      # If email is empty, return original output with format</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="63">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      if email_content.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">        return {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          email: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">          formatted_email: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">          format: format,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">          company: company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">          recipient: recipient</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      # Default to true unless explicitly set to false (check all key variations)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="73">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      allow_bold = !(settings[:allow_bold] == false || settings[&quot;allow_bold&quot;] == false || settings[:allowBold] == false || settings[&quot;allowBold&quot;] == false)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="74">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      allow_italic = !(settings[:allow_italic] == false || settings[&quot;allow_italic&quot;] == false || settings[:allowItalic] == false || settings[&quot;allowItalic&quot;] == false)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="75">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      allow_bullets = !(settings[:allow_bullets] == false || settings[&quot;allow_bullets&quot;] == false || settings[:allowBullets] == false || settings[&quot;allowBullets&quot;] == false)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="76">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      cta_style = settings[:cta_style] || settings[&quot;cta_style&quot;] || settings[:ctaStyle] || settings[&quot;ctaStyle&quot;] || &quot;link&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="77">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      font_family = settings[:font_family] || settings[&quot;font_family&quot;] || settings[:fontFamily] || settings[&quot;fontFamily&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="79">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      prompt = build_prompt(email_content, company, recipient, format: format, allow_bold: allow_bold, allow_italic: allow_italic, allow_bullets: allow_bullets, cta_style: cta_style, font_family: font_family)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      # Build full prompt with system instructions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="82">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      full_prompt = &quot;You are an expert email designer who enhances email content with strategic formatting to improve readability and engagement. Apply bold and italic formatting thoughtfully.\n\n#{prompt}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="84">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">      response = self.class.post(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        &quot;/models/#{@model}:generateContent?key=#{@api_key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        headers: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">          &quot;Content-Type&quot; =&gt; &quot;application/json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        body: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">          contents: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">              parts: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">                {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">                  text: full_prompt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">                }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">              ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">          ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">          generationConfig: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">            temperature: 0.3,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">            maxOutputTokens: 8192</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">        }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="106">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      parsed_response = JSON.parse(response.body)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">      # Extract formatted email from Gemini response</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="109">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      candidate = parsed_response.dig(&quot;candidates&quot;, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="111">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      if candidate &amp;&amp; candidate[&quot;content&quot;] &amp;&amp; candidate[&quot;content&quot;][&quot;parts&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="112">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        formatted_email = candidate[&quot;content&quot;][&quot;parts&quot;][0][&quot;text&quot;] || email_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="114">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        formatted_email = email_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="118">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        email: formatted_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">        formatted_email: formatted_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">        format: format,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">        company: company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">        recipient: recipient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">        original_email: email_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="127">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        email: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">        formatted_email: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">        format: format,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">        company: company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">        recipient: recipient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">        original_email: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">        error: &quot;DesignAgent LLM error: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="137">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="139">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_prompt(email_content, company, recipient, format: &quot;formatted&quot;, allow_bold: true, allow_italic: true, allow_bullets: true, cta_style: &quot;link&quot;, font_family: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">      # If format is plain_text, return the content as-is without formatting instructions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="141">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      if format == &quot;plain_text&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="142">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        prompt = &quot;Return the following email content as plain text without any formatting:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="143">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        prompt += &quot;- Do not add any markdown, HTML, or other formatting\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="144">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        prompt += &quot;- Keep the exact same structure and content\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="146">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt = &quot;Apply formatting to the following email content using markdown syntax:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">        # Conditionally include formatting instructions based on settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="149">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        if allow_bold</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="150">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          prompt += &quot;- Use **bold** for: company names, key terms, important concepts, product names, and call-to-action phrases\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="153">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        if allow_italic</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="154">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">          prompt += &quot;- Use *italic* for: emphasis, quotes, subtle highlights, and secondary important information\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="157">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        if allow_bullets</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="158">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          prompt += &quot;- Use bullet points (- or *) for lists when appropriate\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="161">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Use ~~strikethrough~~ for: crossed-out text, discounts, or old prices\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="162">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Use `code` for: technical terms, product codes, or inline code references\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">        # Apply CTA style guidance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="165">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        if cta_style == &quot;button&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="166">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          prompt += &quot;- Format call-to-action phrases as button-style: **[CTA text]** or use emphasis to make them stand out\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="168">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">          prompt += &quot;- Use [link text](url) for: clickable links (only if URLs are provided)\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="171">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Use &gt; quote for: important quotes or testimonials\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="172">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Keep the Subject line unchanged (do not format it)\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="173">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Maintain all line breaks and structure\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="174">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Do not change the content, only add formatting\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="175">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;- Be selective - don&#39;t over-format. Only format truly important elements\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">        # Apply font family guidance if relevant (mainly for documentation, not directly applicable to markdown)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="178">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        if font_family</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="179">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          prompt += &quot;- Consider typography: #{font_family == &#39;serif&#39; ? &#39;Use serif-style emphasis for formal content&#39; : &#39;Use system sans-serif style for modern, clean appearance&#39;}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="182">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        prompt += &quot;\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="185">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      if company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="186">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        prompt += &quot;Company: #{company}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="189">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      if recipient</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="190">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        prompt += &quot;Recipient: #{recipient}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="193">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      prompt += &quot;\nEmail content to format:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="194">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      prompt += &quot;---\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="195">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      prompt += email_content</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="196">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      prompt += &quot;\n---\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="198">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      prompt += &quot;Return the formatted email with markdown formatting applied. Keep the exact same structure and content, only add formatting (bold, italic, strikethrough, code, links, quotes) where appropriate.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="200">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      prompt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8ca4839bca54b1f2e2afdd4fae89a24f58e4b1e0">
  <div class="header">
    <h3>app/services/agents/search_agent.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>43</b> relevant lines.
      <span class="green"><b>43</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># app/services/agents/search_agent.rb</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;httparty&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;logger&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Agents</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class SearchAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    include HTTParty</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    base_uri &quot;https://api.tavily.com&quot;  # For Tavily</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    GEMINI_URL = &quot;https://generativelanguage.googleapis.com/v1beta&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize(tavily_key:, gemini_key:, model: &quot;gemini-2.5-flash&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="15">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Tavily API key is required&quot; if tavily_key.nil? || tavily_key.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="16">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Gemini API key is required&quot; if gemini_key.nil? || gemini_key.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="18">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @tavily_key = tavily_key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="19">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @gemini_key = gemini_key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="20">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @model = model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="21">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @logger = ::Logger.new($stdout)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def run(company:, recipient_name:, job_title:, email:, tone: nil, persona: nil, goal: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      identity = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="26">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        name: recipient_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        company: company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">        job_title: job_title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">        email: email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="32">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      @logger.info(&quot;SearchAgent: Personalization lookup for #{recipient_name} @ #{company}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="34">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      inferred_focus_areas = infer_focus_areas(identity, tone: tone, persona: persona, goal: goal)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="36">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      recipient_query = &quot;#{recipient_name} #{company} #{job_title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="37">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      company_query = &quot;#{company} #{inferred_focus_areas.join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="39">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      recipient_signals = run_tavily_search(recipient_query)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="40">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      company_signals = run_tavily_search(company_query)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="43">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        target_identity: identity,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">        inferred_focus_areas: inferred_focus_areas,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        personalization_signals: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">          recipient: recipient_signals,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">          company: company_signals</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="54">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def infer_focus_areas(identity, tone:, persona:, goal:)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="55">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      tone ||= &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="56">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      persona ||= &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="57">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      goal ||= &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="59">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      prompt = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        Given the recipient below, infer 35 technical focus areas or themes likely relevant to them in their work. Output only a JSON array of short phrases.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        Recipient:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">        - Name: #{identity[:name]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">        - Job Title: #{identity[:job_title]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">        - Company: #{identity[:company]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">        - Email: #{identity[:email]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">        - Sender Persona: #{persona}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">        - Email Tone: #{tone}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        - Goal: #{goal}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="71">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      response = HTTParty.post(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">        &quot;https://generativelanguage.googleapis.com/v1beta/models/#{@model}:generateContent?key=#{@gemini_key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">        headers: { &quot;Content-Type&quot; =&gt; &quot;application/json&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">        body: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">          contents: [ { parts: [ { text: prompt } ] } ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">        }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="79">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      raw = response.parsed_response.dig(&quot;candidates&quot;, 0, &quot;content&quot;, &quot;parts&quot;, 0, &quot;text&quot;) || &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      # @logger.debug(&quot;Gemini raw response: #{raw}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      # Remove markdown and surrounding quotes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="84">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      cleaned = raw</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        .gsub(/```json/i, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        .gsub(/```/, &quot;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">        .gsub(/\A\s+|\s+\z/, &quot;&quot;)  # trim leading/trailing whitespace</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        .gsub(&quot;\n&quot;, &quot;&quot;)           # remove line breaks</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="90">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      JSON.parse(cleaned)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="92">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      @logger.error(&quot;Gemini inference failed: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="93">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="98">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def run_tavily_search(query)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="99">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">      response = self.class.post(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">        &quot;/search&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        headers: { &quot;Content-Type&quot; =&gt; &quot;application/json&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">        body: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">          api_key: @tavily_key,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">          query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">          search_depth: &quot;advanced&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">          include_answer: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">          include_raw_content: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">          max_results: 5</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">        }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="113">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">        sources = response.parsed_response[&quot;results&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="114">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        sources&amp;.map do |result|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="116">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            title: result[&quot;title&quot;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">            url: result[&quot;url&quot;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">            content: result[&quot;content&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">        end || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="122">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        @logger.error(&quot;Tavily batch search failed: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="123">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="07a85b4b12642589644693c0b3779002835162f5">
  <div class="header">
    <h3>app/services/agents/writer_agent.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>106</b> relevant lines.
      <span class="green"><b>106</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;httparty&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require &quot;json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">=begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">WRITER AGENT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">OVERVIEW:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">The WriterAgent uses Google&#39;s Gemini AI to generate personalized, contextually-aware B2B marketing emails</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">for target companies. It transforms research data from SearchAgent into compelling, human-like outreach emails.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">HOW IT WORKS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">1. Receives search results from SearchAgent containing company news</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">2. Receives target company name (and optional recipient name)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">3. Builds a comprehensive prompt that includes:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">   - Research sources (title, URL, content) obtained from SearchAgent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">   - Company name and recipient information</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">   - B2B email best practices (subject line, CTA, tone, spam prevention)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">   - Specific formatting requirements</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">4. Calls Gemini API to generate email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">5. Returns email with subject line and body</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">INPUT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">search_results:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    company: &quot;Microsoft&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    sources: [{title: &quot;...&quot;, url: &quot;...&quot;, content: &quot;...&quot;}, ...],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    image: &quot;https://...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">recipient: &quot;John Doe&quot; (optional)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">company: &quot;Microsoft&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">OUTPUT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">{</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  company: &quot;Microsoft&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  email: &quot;Subject: ...\n\nHi John,\n...&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  recipient: &quot;John Doe&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  sources: [...],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  image: &quot;...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">KEY FEATURES:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">- Personalizes emails based on real-time company news</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">- References specific articles and developments to show research</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">- Creates empathetic, human-like tone (not robotic or spammy)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">- Generates compelling subject lines and clear CTAs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">- Includes spam-prevention best practices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">- Professional yet warm B2B tone</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">=end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module Agents</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class WriterAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    include HTTParty</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="53">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    base_uri &quot;https://generativelanguage.googleapis.com/v1beta&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="55">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def initialize(api_key:, model: &quot;gemini-2.5-flash&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="56">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @api_key = api_key</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="57">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      @model = model</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="84" data-linenumber="58">
            
              <span class="hits">84</span>
            

            

            <code class="ruby">      raise ArgumentError, &quot;Gemini API key is required&quot; if @api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="61">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def run(search_results, recipient: nil, company: nil, product_info: nil, sender_company: nil, config: nil, shared_settings: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="62">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      company_name = company || search_results[:company]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="63">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      sources = search_results[:sources]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="64">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      focus_areas = search_results[:inferred_focus_areas] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      # Get settings from config or use defaults</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="67">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      settings = config&amp;.dig(&quot;settings&quot;) || config&amp;.dig(:settings) || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="68">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      brand_voice = shared_settings&amp;.dig(&quot;brand_voice&quot;) || shared_settings&amp;.dig(:brand_voice) || {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      # Use config settings, fallback to shared_settings, then defaults</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="71">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      tone = settings[&quot;tone&quot;] || settings[:tone] || brand_voice[&quot;tone&quot;] || brand_voice[:tone] || &quot;professional&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="72">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      sender_persona = settings[&quot;sender_persona&quot;] || settings[:sender_persona] || brand_voice[&quot;persona&quot;] || brand_voice[:persona] || &quot;founder&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="73">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      email_length = settings[&quot;email_length&quot;] || settings[:email_length] || &quot;short&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="74">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      personalization_level = settings[&quot;personalization_level&quot;] || settings[:personalization_level] || &quot;medium&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="75">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      primary_cta_type = settings[&quot;primary_cta_type&quot;] || settings[:primary_cta_type] || shared_settings&amp;.dig(&quot;primary_goal&quot;) || shared_settings&amp;.dig(:primary_goal) || &quot;book_call&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="76">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      cta_softness = settings[&quot;cta_softness&quot;] || settings[:cta_softness] || &quot;balanced&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="77">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      num_variants = (settings[&quot;num_variants_per_lead&quot;] || settings[:num_variants_per_lead] || 2).to_i</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="78">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      num_variants = [ 1, [ num_variants, 3 ].min ].max # Clamp between 1 and 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">      # Get product_info and sender_company from shared_settings as fallback</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="81">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      product_info = product_info || shared_settings&amp;.dig(&quot;product_info&quot;) || shared_settings&amp;.dig(:product_info) || settings[&quot;product_info&quot;] || settings[:product_info]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="82">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      sender_company = sender_company || shared_settings&amp;.dig(&quot;sender_company&quot;) || shared_settings&amp;.dig(:sender_company) || settings[&quot;sender_company&quot;] || settings[:sender_company]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">      # Generate multiple variants if requested</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="85">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      variants = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="86">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      num_variants.times do |variant_index|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="87">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">        prompt = build_prompt(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">          company_name, sources, recipient, company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">          product_info, sender_company, tone, sender_persona, email_length,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">          personalization_level, primary_cta_type, cta_softness, variant_index, num_variants, focus_areas</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">        # Build full prompt with system instructions</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="94">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">        full_prompt = &quot;You are an expert B2B marketing email writer who creates personalized, empathetic, and engaging outreach emails that build authentic customer relationships and drive engagement.\n\n#{prompt}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="96">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">        response = self.class.post(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">          &quot;/models/#{@model}:generateContent?key=#{@api_key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">          headers: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">            &quot;Content-Type&quot; =&gt; &quot;application/json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">          },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">          body: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">            contents: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">                parts: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">                    text: full_prompt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">            ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">            generationConfig: {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="112">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">              temperature: 0.75 + (variant_index * 0.1), # Slight variation in temperature for diversity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">              maxOutputTokens: 8192</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">          }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="118">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">        parsed_response = JSON.parse(response.body)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">        # Extract email text from Gemini response</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="121">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">        candidate = parsed_response.dig(&quot;candidates&quot;, 0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="123">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">        if candidate &amp;&amp; candidate[&quot;content&quot;] &amp;&amp; candidate[&quot;content&quot;][&quot;parts&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="124">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          email = candidate[&quot;content&quot;][&quot;parts&quot;][0][&quot;text&quot;] || &quot;Failed to generate email&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="42" data-linenumber="126">
            
              <span class="hits">42</span>
            

            

            <code class="ruby">          email = &quot;Failed to generate email&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="129">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">        variants &lt;&lt; email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">      # Return primary email (first variant) and all variants</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="134">
            
              <span class="hits">22</span>
            

            

            <code class="ruby">        company: company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">        email: variants.first || &quot;Failed to generate email&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">        variants: variants,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">        recipient: recipient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">        sources: sources,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">        product_info: product_info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">        sender_company: sender_company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="144">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        company: company || search_results[:company],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">        email: &quot;Error generating email: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">        recipient: recipient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">        sources: search_results[:sources],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">        product_info: product_info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">        sender_company: sender_company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">        error: &quot;WriterAgent LLM error: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="154">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="156">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_prompt(company_name, sources, recipient, company, product_info, sender_company, tone, sender_persona, email_length, personalization_level, primary_cta_type, cta_softness, variant_index = 0, total_variants = 1, focus_areas = [])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="157">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt = &quot;Write a personalized B2B marketing outreach email&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="158">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot; to #{recipient}&quot; if recipient</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="159">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot; at #{company}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="160">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;.\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">      # Add sender company and product context if provided</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="163">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      if sender_company || product_info</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="164">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        prompt += &quot;CONTEXT ABOUT YOUR COMPANY AND PRODUCT:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="165">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        prompt += &quot;#{sender_company}\n\n&quot; if sender_company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="166">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        prompt += &quot;#{product_info}\n\n&quot; if product_info</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="169">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      if sources &amp;&amp; !sources.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="170">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        prompt += &quot;Use the following real-time research sources to create contextually relevant content:\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="171">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        sources.each_with_index do |source, index|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="172">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          prompt += &quot;Source #{index + 1}:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="173">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          prompt += &quot;Title: #{source[&#39;title&#39;]}\n&quot; if source[&quot;title&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="174">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          prompt += &quot;URL: #{source[&#39;url&#39;]}\n&quot; if source[&quot;url&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="175">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          prompt += &quot;Content: #{source[&#39;content&#39;] || &#39;No content available&#39;}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="176">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          prompt += &quot;\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="43" data-linenumber="179">
            
              <span class="hits">43</span>
            

            

            <code class="ruby">        prompt += &quot;Note: Limited sources found. Craft a compelling email that addresses key pain points.\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="182">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      if focus_areas.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="183">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        prompt += &quot;The recipient&#39;s technical focus areas include: #{focus_areas.join(&#39;, &#39;)}\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="186">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;CRITICAL REQUIREMENTS:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="187">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Subject Line: Compelling and personalized (max 50 chars recommended)\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">      # Personalization level guidance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="190">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      case personalization_level</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      when &quot;low&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="192">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        prompt += &quot;- Opening: Light references to industry or company only\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">      when &quot;medium&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="39" data-linenumber="194">
            
              <span class="hits">39</span>
            

            

            <code class="ruby">        prompt += &quot;- Opening: Create emotional connection by referencing recent company news or industry developments. Include a clear sentence about the company or a recent event.\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby">      when &quot;high&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="196">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        prompt += &quot;- Opening: Heavily tailored opener that demonstrates deep research. Reference specific details, recent events, or unique company characteristics.\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="198">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        prompt += &quot;- Opening: Create emotional connection by referencing recent company news or industry developments\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="201">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Value Proposition: Clearly articulate how your solution addresses their specific pain points\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="202">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Personalization Level: #{personalization_level.upcase} - #{personalization_level == &#39;low&#39; ? &#39;Light references only&#39; : personalization_level == &#39;medium&#39; ? &#39;Clear sentence about company or recent event&#39; : &#39;Heavily tailored opener + body&#39;}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">      # Tone guidance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="205">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      tone_guidance = case tone</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">      when &quot;formal&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="207">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        &quot;Formal, respectful, and business-appropriate. Use professional language and structure.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">      when &quot;professional&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="37" data-linenumber="209">
            
              <span class="hits">37</span>
            

            

            <code class="ruby">        &quot;Professional yet warm, empathetic, and human-like (not robotic or spammy)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">      when &quot;friendly&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="211">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        &quot;Friendly and approachable while maintaining professionalism. Conversational but not casual.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="213">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        &quot;Professional yet warm, empathetic, and human-like&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="215">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Tone: #{tone_guidance}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="216">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Sender Persona: Write as a #{sender_persona} (#{sender_persona == &#39;founder&#39; ? &#39;thoughtful leader&#39; : sender_persona == &#39;sales&#39; ? &#39;helpful sales professional&#39; : &#39;supportive customer success manager&#39;})\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">      # Email length guidance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="219">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      length_guidance = case email_length</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">      when &quot;very_short&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="221">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        &quot;Very Short: 50-100 words. Extremely concise, get to the point immediately.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">      when &quot;short&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="39" data-linenumber="223">
            
              <span class="hits">39</span>
            

            

            <code class="ruby">        &quot;Short: 100-200 words. Concise and scannable, ideal for B2B outreach.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">      when &quot;standard&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="225">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        &quot;Standard: 200-300 words. More detailed but still scannable.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="227">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        &quot;Concise and scannable (150-300 words ideal for B2B outreach)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="229">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Length: #{length_guidance}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">      # CTA guidance</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="232">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      cta_guidance = case primary_cta_type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">      when &quot;book_call&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="39" data-linenumber="234">
            
              <span class="hits">39</span>
            

            

            <code class="ruby">        &quot;Propose a short intro meeting (15-30 minutes). Make it easy to schedule.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">      when &quot;get_reply&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="236">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        &quot;Ask for a quick email response. Pose a thoughtful question or request feedback.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">      when &quot;get_click&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="238">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        &quot;Drive to a link/demo/landing page. Provide clear value proposition for clicking.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="240">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        &quot;Clear, compelling CTA that provides next steps&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="243">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      cta_softness_guidance = case cta_softness</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">      when &quot;soft&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="245">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        &quot;Use gentle, non-pushy language. &#39;Would you be open to...&#39; or &#39;I&#39;d love to...&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            

            

            <code class="ruby">      when &quot;balanced&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="39" data-linenumber="247">
            
              <span class="hits">39</span>
            

            

            <code class="ruby">        &quot;Use moderate assertiveness. &#39;I&#39;d like to...&#39; or &#39;Let&#39;s...&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">      when &quot;direct&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="249">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        &quot;Use clear and assertive language. &#39;Let&#39;s schedule...&#39; or &#39;I recommend...&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="251">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        &quot;Use balanced approach&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="253">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="254">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Call-to-Action: #{cta_guidance}. CTA Softness: #{cta_softness_guidance}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">      # Add variant instruction if generating multiple variants</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="257">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      if total_variants &gt; 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="258">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">        prompt += &quot;- Variant #{variant_index + 1} of #{total_variants}: Create a unique variation while maintaining quality. Vary the opening, structure, or approach while keeping the core message consistent.\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="261">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Spam Prevention: Avoid excessive promotional language, all caps, or multiple exclamation marks\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="263">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;Focus on:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="264">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Building authentic relationships, not just selling\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="265">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Demonstrating understanding of their business context\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="266">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Providing genuine value and insights\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="267">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;- Creating an emotional connection while maintaining professionalism\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="268">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="269">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;Format the output as:\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="270">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;Subject: [email subject]\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="271">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt += &quot;[email body]&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="273">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      prompt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="274">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="276">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="00ebc34188ddbf1df657b7c96d32bb07ae2db59d">
  <div class="header">
    <h3>app/services/api_key_service.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>19</b> relevant lines.
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># ApiKeyService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Handles retrieval of API keys from the current user for agent services.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># Provides centralized access to Gemini and Tavily API keys with proper error handling.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"># Usage:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">#   gemini_key = ApiKeyService.get_gemini_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#   tavily_key = ApiKeyService.get_tavily_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApiKeyService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class &lt;&lt; self</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Retrieves the Gemini API key from the user record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # @param user [User] Current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    # @return [String] Gemini API key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # @raise [ArgumentError] if API key is missing or blank</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def get_gemini_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="79" data-linenumber="19">
            
              <span class="hits">79</span>
            

            

            <code class="ruby">      key = user&amp;.llm_api_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="79" data-linenumber="21">
            
              <span class="hits">79</span>
            

            

            <code class="ruby">      if key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise ArgumentError, &quot;Gemini API key is required. Please add your Gemini API key in the API Keys section.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="25">
            
              <span class="hits">78</span>
            

            

            <code class="ruby">      key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # Retrieves the Tavily API key from the user record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # @param user [User] Current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    # @return [String] Tavily API key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    # @raise [ArgumentError] if API key is missing or blank</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def get_tavily_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="79" data-linenumber="34">
            
              <span class="hits">79</span>
            

            

            <code class="ruby">      key = user&amp;.tavily_api_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="79" data-linenumber="36">
            
              <span class="hits">79</span>
            

            

            <code class="ruby">      if key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise ArgumentError, &quot;Tavily API key is required. Please add your Tavily API key in the API Keys section.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="78" data-linenumber="40">
            
              <span class="hits">78</span>
            

            

            <code class="ruby">      key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    # Checks if both API keys are available on the user record</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    # @param user [User] Current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # @return [Boolean] true if both keys are present and not blank</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def keys_available?(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="91" data-linenumber="48">
            
              <span class="hits">91</span>
            

            

            <code class="ruby">      user&amp;.llm_api_key.present? &amp;&amp; user&amp;.tavily_api_key.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    # Returns a list of missing API keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    # @param user [User] Current user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    # @return [Array&lt;String&gt;] Array of missing key names</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="55">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def missing_keys(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="56">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      missing = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      missing &lt;&lt; &quot;Gemini&quot; if user&amp;.llm_api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      missing &lt;&lt; &quot;Tavily&quot; if user&amp;.tavily_api_key.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      missing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e31c4fe0093b9112f117ae8bff788e0410b53bc5">
  <div class="header">
    <h3>app/services/email_sender_service.rb</h3>
    <h4>
      <span class="green">
  97.18%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>177</b> relevant lines.
      <span class="green"><b>172</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># EmailSenderService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Service responsible for sending emails to leads that have completed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># the agent processing pipeline (SEARCH  WRITER  CRITIQUE  DESIGN).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"># Usage:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">#   EmailSenderService.send_emails_for_campaign(campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#   # Returns: { sent: 5, failed: 2, errors: [...] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class EmailSenderService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  include AgentConstants</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class &lt;&lt; self</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # Sends emails to all ready leads in a campaign</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    # A lead is considered &quot;ready&quot; if it has completed the DESIGN agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # (or WRITER agent if DESIGN is disabled) and reached &#39;designed&#39; or &#39;completed&#39; stage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    # @param campaign [Campaign] The campaign containing leads to send emails to</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # @return [Hash] Result with counts of sent/failed emails and any errors</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def send_emails_for_campaign(campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="22">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      ready_leads = find_ready_leads(campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      results = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="25">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        sent: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">        failed: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        errors: []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="30">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      ready_leads.each do |lead|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="32">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">          Rails.logger.info(&quot;[EmailSender] Attempting to send email to lead #{lead.id} (#{lead.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="33">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">          send_email_to_lead(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="34">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">          results[:sent] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="35">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">          Rails.logger.info(&quot;[EmailSender] Successfully sent email to lead #{lead.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="37">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          results[:failed] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="38">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          results[:errors] &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">            lead_id: lead.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">            lead_email: lead.email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">            error: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="43">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          Rails.logger.error(&quot;[EmailSender] Failed to send email to lead #{lead.id}: #{e.class} #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="44">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">          Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="48">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      results</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    # Sends email to a single lead</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    # This is a public method that can be called directly</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    # @param lead [Lead] The lead to send email to</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    # @return [Hash] Result with success status and any error message</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def send_email_for_lead(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      # Verify lead belongs to a campaign owned by a user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="59">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">      unless lead.campaign&amp;.user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        return {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="61">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">          error: &quot;Lead does not belong to a valid campaign&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      # Check if lead is ready</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="67">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      unless lead_ready?(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">        return {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="69">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">          error: &quot;Lead is not ready to send. Lead must be at &#39;designed&#39; or &#39;completed&#39; stage with email content available.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="75">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Attempting to send email to lead #{lead.id} (#{lead.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="19" data-linenumber="76">
            
              <span class="hits">19</span>
            

            

            <code class="ruby">        send_email_to_lead(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="77">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Successfully sent email to lead #{lead.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="79">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">          message: &quot;Email sent successfully to #{lead.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="83">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Failed to send email to lead #{lead.id}: #{e.class} #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="84">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="11" data-linenumber="86">
            
              <span class="hits">11</span>
            

            

            <code class="ruby">          success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">          error: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">    # Checks if a lead is ready to have its email sent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    # A lead is ready if:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">    # 1. It has reached &#39;designed&#39; or &#39;completed&#39; stage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">    # 2. It has a completed DESIGN output (preferred) or WRITER output (fallback)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">    #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    # @param lead [Lead] The lead to check</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">    # @return [Boolean] True if lead is ready to send</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="100">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def lead_ready?(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">      # Must be at designed or completed stage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="102">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">      return false unless lead.stage.in?([ AgentConstants::STAGE_DESIGNED, AgentConstants::STAGE_COMPLETED ])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      # Check for DESIGN output first (preferred)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="105">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      design_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_DESIGN, status: AgentConstants::STATUS_COMPLETED)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="106">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      if design_output &amp;&amp; design_output.output_data[&quot;formatted_email&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="107">
            
              <span class="hits">28</span>
            

            

            <code class="ruby">        return true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">      # Fallback to WRITER output if DESIGN is not available</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="111">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      writer_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_WRITER, status: AgentConstants::STATUS_COMPLETED)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="112">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      if writer_output &amp;&amp; writer_output.output_data[&quot;email&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="113">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">        return true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="116">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="119">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">    # Finds all leads in a campaign that are ready to send</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="123">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def find_ready_leads(campaign)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="38" data-linenumber="124">
            
              <span class="hits">38</span>
            

            

            <code class="ruby">      campaign.leads.select { |lead| lead_ready?(lead) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">    # Sends email to a single lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="129">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def send_email_to_lead(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      # Get the email content (prefer DESIGN formatted_email, fallback to WRITER email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="131">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      design_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_DESIGN, status: AgentConstants::STATUS_COMPLETED)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="132">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      writer_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_WRITER, status: AgentConstants::STATUS_COMPLETED)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="134">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      email_content = nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="135">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      if design_output &amp;&amp; design_output.output_data[&quot;formatted_email&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="30" data-linenumber="136">
            
              <span class="hits">30</span>
            

            

            <code class="ruby">        email_content = design_output.output_data[&quot;formatted_email&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="137">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">      elsif writer_output &amp;&amp; writer_output.output_data[&quot;email&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="138">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">        email_content = writer_output.output_data[&quot;email&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="141">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      raise &quot;No email content found for lead #{lead.id}&quot; if email_content.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="143">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      user = lead.campaign.user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">      # Use configured send_from_email, fallback to user email, then default</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="145">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      from_email = user&amp;.send_from_email.presence || user&amp;.email.presence || ApplicationMailer.default[:from]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">      #  Minimal change: use from_email to find OAuth user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="148">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Using from_email: #{from_email}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="149">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Campaign owner: user #{user&amp;.id} (#{user&amp;.email}), send_from_email: #{user&amp;.send_from_email}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="150">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      oauth_user = User.find_by(email: from_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="151">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] OAuth user lookup: #{oauth_user&amp;.id} (#{oauth_user&amp;.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">      # Check OAuth configuration with detailed logging</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="154">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      oauth_check_result = oauth_user ? GmailOauthService.oauth_configured?(oauth_user) : false</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="155">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] OAuth check result: #{oauth_check_result} for user #{oauth_user&amp;.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="40" data-linenumber="157">
            
              <span class="hits">40</span>
            

            

            <code class="ruby">      if oauth_user &amp;&amp; oauth_check_result</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="158">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] OAuth configured for oauth_user #{oauth_user.id}, getting access token...&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="159">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] User #{oauth_user.id} has refresh_token: #{oauth_user.gmail_refresh_token.present?}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="160">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        access_token = GmailOauthService.valid_access_token(oauth_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="161">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Access token present: #{access_token.present?}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="13" data-linenumber="162">
            
              <span class="hits">13</span>
            

            

            <code class="ruby">        if access_token</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="163">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          Rails.logger.info(&quot;[EmailSender] Using Gmail API to send email (OAuth configured) as #{from_email}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="164">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          send_via_gmail_api(lead, email_content, from_email, oauth_user, access_token)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="165">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="167">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          Rails.logger.warn(&quot;[EmailSender] OAuth configured but valid_access_token returned nil for user #{oauth_user.id}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="170">
            
              <span class="hits">27</span>
            

            

            <code class="ruby">        if oauth_user.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="171">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          Rails.logger.warn(&quot;[EmailSender] No user found with email: #{from_email}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="25" data-linenumber="173">
            
              <span class="hits">25</span>
            

            

            <code class="ruby">          Rails.logger.warn(&quot;[EmailSender] OAuth NOT configured for from_email user (#{from_email}, user_id: #{oauth_user.id})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">        # Check if this is a Gmail address that needs OAuth</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="176">
            
              <span class="hits">27</span>
            

            

            <code class="ruby">        if from_email&amp;.include?(&quot;@gmail.com&quot;) || from_email&amp;.include?(&quot;@googlemail.com&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">          if oauth_user.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">            error_msg = &quot;No user account found for sending email address: #{from_email}. Please ensure this email address has a user account in the system.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">            error_msg = &quot;Gmail OAuth is not configured for #{from_email}. Please log in as this user and complete Gmail OAuth authorization in Email Settings.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">          Rails.logger.error(&quot;[EmailSender] #{error_msg}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">          raise error_msg</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="27" data-linenumber="185">
            
              <span class="hits">27</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Falling back to SMTP for non-Gmail address.&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">      # Fallback to SMTP (OAuth or password-based)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="189">
            
              <span class="hits">33</span>
            

            

            <code class="ruby">      configure_delivery_method(user) if user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      # Force SMTP delivery method (override development file delivery)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="192">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      ActionMailer::Base.delivery_method = :smtp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="193">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      ActionMailer::Base.perform_deliveries = true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="195">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Pre-mail config - delivery_method: #{ActionMailer::Base.delivery_method}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="196">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Pre-mail config - smtp_settings address: #{ActionMailer::Base.smtp_settings[:address]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">      # Send email using CampaignMailer</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="199">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      mail = CampaignMailer.send_email(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">        to: lead.email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">        recipient_name: lead.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">        email_content: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">        campaign_title: lead.campaign.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">        from_email: from_email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">      # Final verification - delivery_method should still be :smtp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="208">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      if ActionMailer::Base.delivery_method != :smtp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="209">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] CRITICAL: Delivery method changed to #{ActionMailer::Base.delivery_method} after mail creation!&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="210">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        ActionMailer::Base.delivery_method = :smtp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="211">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        configure_delivery_method(user) if user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="214">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Mail object created, delivery_method: #{ActionMailer::Base.delivery_method}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="215">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] SMTP address: #{ActionMailer::Base.smtp_settings[:address]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="216">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] SMTP user_name: #{ActionMailer::Base.smtp_settings[:user_name]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="219">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Attempting to deliver mail via #{ActionMailer::Base.delivery_method}...&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="220">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">        mail.deliver_now</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="221">
            
              <span class="hits">20</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Mail delivered successfully via #{ActionMailer::Base.delivery_method}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">      rescue Net::SMTPAuthenticationError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="223">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] SMTP Authentication Error: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="224">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Response code: #{e.response.code if e.respond_to?(:response)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="225">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Response message: #{e.response.message if e.respond_to?(:response)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="226">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="227">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">      rescue Net::SMTPError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="229">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] SMTP Error: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="230">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Response: #{e.response.inspect if e.respond_to?(:response)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="231">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="232">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">      rescue OpenSSL::SSL::SSLError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="234">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] SSL Error: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="235">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="236">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">      rescue Errno::ECONNREFUSED, Errno::ETIMEDOUT, Timeout::Error =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="238">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Connection Error: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="239">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="240">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="242">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Unexpected error delivering mail: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="243">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="244">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            

            

            <code class="ruby">    # Sends email via Gmail API (more reliable than SMTP XOAUTH2)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="250">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def send_via_gmail_api(lead, email_content, from_email, oauth_user, access_token)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="251">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      require &quot;net/http&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="252">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      require &quot;uri&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="253">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      require &quot;base64&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">      # Build email message in RFC 2822 format</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="256">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      mail = CampaignMailer.send_email(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">        to: lead.email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">        recipient_name: lead.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">        email_content: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            

            <code class="ruby">        campaign_title: lead.campaign.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby">        from_email: from_email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="263">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby">      # Get the raw email content</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="265">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      raw_email = mail.encoded</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            

            <code class="ruby">      # Encode to base64url (Gmail API requirement)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="268">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      raw_email_base64 = Base64.urlsafe_encode64(raw_email)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            

            <code class="ruby">      # Send via Gmail API</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="271">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      uri = URI(&quot;https://gmail.googleapis.com/gmail/v1/users/me/messages/send&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="272">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      http = Net::HTTP.new(uri.host, uri.port)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="273">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      http.use_ssl = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="274">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      http.verify_mode = OpenSSL::SSL::VERIFY_NONE if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="276">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      request = Net::HTTP::Post.new(uri)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="277">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      request[&quot;Authorization&quot;] = &quot;Bearer #{access_token}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="278">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      request[&quot;Content-Type&quot;] = &quot;application/json&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="279">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      request.body = { raw: raw_email_base64 }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="280">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="281">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Sending email via Gmail API to #{lead.email}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="282">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      response = http.request(request)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="283">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="284">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      if response.code == &quot;200&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="285">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Email sent successfully via Gmail API&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="286">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        result = JSON.parse(response.body)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="287">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Gmail message ID: #{result[&#39;id&#39;]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="288">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="289">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        error_body = response.body[0..500]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="290">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] Gmail API error: #{response.code} - #{error_body}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="291">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        raise &quot;Gmail API error: #{response.code} - #{error_body}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="292">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="293">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="294">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      Rails.logger.error(&quot;[EmailSender] Gmail API send failed: #{e.class} - #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="295">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="296">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="299">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="300">
            

            

            <code class="ruby">    # Configures ActionMailer delivery method for OAuth2 or fallback to password</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="301">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def configure_delivery_method(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="302">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Configuring delivery method for user #{user.id} (#{user.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby">      # Determine which email will be used for sending</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="305">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      send_from_email = user.send_from_email.presence || user.email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="306">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Will send from: #{send_from_email}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="307">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            

            

            <code class="ruby">      #  Minimal change: use send_from_email to find OAuth user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="309">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      oauth_user = User.find_by(email: send_from_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="310">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] SMTP OAuth user lookup: #{oauth_user&amp;.id} (#{oauth_user&amp;.email})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="312">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      oauth_configured = oauth_user &amp;&amp; GmailOauthService.oauth_configured?(oauth_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="313">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] OAuth configured for this from_email user: #{oauth_configured}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="34" data-linenumber="315">
            
              <span class="hits">34</span>
            

            

            <code class="ruby">      if oauth_configured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="316">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        access_token = GmailOauthService.valid_access_token(oauth_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="317">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Access token available: #{access_token.present?}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="319">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        if access_token</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="320">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          ActionMailer::Base.delivery_method = :smtp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="321">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          smtp_settings = build_oauth2_smtp_settings(oauth_user, access_token, send_from_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="322">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          ActionMailer::Base.smtp_settings = smtp_settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            

            <code class="ruby">          # Force reload of mailer configuration</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="324">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          ActionMailer::Base.perform_deliveries = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="325">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          Rails.logger.info(&quot;[EmailSender] Configured OAuth2 SMTP with user: #{smtp_settings[:user_name]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="326">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          Rails.logger.info(&quot;[EmailSender] Delivery method set to: #{ActionMailer::Base.delivery_method}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="327">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          Rails.logger.info(&quot;[EmailSender] Perform deliveries: #{ActionMailer::Base.perform_deliveries}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="328">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          return</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="329">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="330">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">          Rails.logger.warn(&quot;[EmailSender] OAuth configured but no valid access token available&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="332">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="333">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby">      # Fallback to password-based SMTP if configured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="32" data-linenumber="335">
            
              <span class="hits">32</span>
            

            

            <code class="ruby">      if ENV[&quot;SMTP_ADDRESS&quot;].present? &amp;&amp; ENV[&quot;SMTP_PASSWORD&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="336">
            
              <span class="hits">31</span>
            

            

            <code class="ruby">        ActionMailer::Base.delivery_method = :smtp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="337">
            
              <span class="hits">31</span>
            

            

            <code class="ruby">        ActionMailer::Base.smtp_settings = build_password_smtp_settings</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="338">
            
              <span class="hits">31</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[EmailSender] Configured password-based SMTP as fallback&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="340">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        error_msg = &quot;No email delivery method configured for #{send_from_email}. Gmail addresses require OAuth configuration. Please configure Gmail OAuth or set SMTP credentials.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="341">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[EmailSender] #{error_msg}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="342">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise error_msg</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="344">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            

            <code class="ruby">    # Builds SMTP settings for OAuth2 authentication</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="348">
            

            

            <code class="ruby">    # Uses gmail_xoauth gem for OAuth2 support</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby">    # @param user [User] The user whose OAuth token to use</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            

            

            <code class="ruby">    # @param access_token [String] The OAuth access token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="351">
            

            

            <code class="ruby">    # @param send_from_email [String] The email address to send from (may differ from user.email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="352">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_oauth2_smtp_settings(user, access_token, send_from_email = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="353">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      require &quot;gmail_xoauth&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="354">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            

            

            <code class="ruby">      # Use provided send_from_email, or user&#39;s send_from_email, or user email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="356">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      smtp_user = send_from_email || user.send_from_email.presence || user.email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="357">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            

            

            <code class="ruby">      # The email in the OAuth string should match the email that was authorized</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            

            

            <code class="ruby">      # For Gmail, the token is tied to the authorized email, so we use user.email (the authorized email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="360">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      oauth_email = user.email  # Use the email that was actually authorized</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="361">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="362">
            

            

            <code class="ruby">      # Generate XOAUTH2 string</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">      # Gmail XOAUTH2 format: user=email\1auth=Bearer token\1\1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="364">
            

            

            <code class="ruby">      # Note: Use plain format (not Base64) - ActionMailer&#39;s Net::SMTP handles encoding</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="365">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      oauth_string = &quot;user=#{oauth_email}\x01auth=Bearer #{access_token}\x01\x01&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="366">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="367">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[EmailSender] Generated OAuth string for authorized email: #{oauth_email}, sending from: #{smtp_user}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="368">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Rails.logger.debug(&quot;[EmailSender] OAuth string length: #{oauth_string.length}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="369">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="370">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="371">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        address: ENV.fetch(&quot;SMTP_ADDRESS&quot;, &quot;smtp.gmail.com&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            

            

            <code class="ruby">        port: ENV.fetch(&quot;SMTP_PORT&quot;, &quot;587&quot;).to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            

            <code class="ruby">        domain: ENV.fetch(&quot;SMTP_DOMAIN&quot;, ENV.fetch(&quot;MAILER_HOST&quot;, &quot;gmail.com&quot;)),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="374">
            

            

            <code class="ruby">        user_name: smtp_user,  # This is the &quot;from&quot; email address</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="375">
            

            

            <code class="ruby">        password: oauth_string,  # OAuth string uses the authorized email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="376">
            

            

            <code class="ruby">        authentication: :plain,   # Use plain auth, OAuth string is in password field</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="377">
            

            

            <code class="ruby">        enable_starttls_auto: ENV.fetch(&quot;SMTP_ENABLE_STARTTLS&quot;, &quot;true&quot;) == &quot;true&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            

            

            <code class="ruby">        # SSL/TLS settings for Gmail</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="379">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        openssl_verify_mode: Rails.env.development? ? &quot;none&quot; : &quot;peer&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="380">
            

            

            <code class="ruby">        ssl: false,  # Use STARTTLS instead of direct SSL</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            

            <code class="ruby">        tls: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="382">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="383">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="384">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="385">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="386">
            

            

            <code class="ruby">    # Builds SMTP settings for password-based authentication</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="387">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_password_smtp_settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="388">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="31" data-linenumber="389">
            
              <span class="hits">31</span>
            

            

            <code class="ruby">        address: ENV.fetch(&quot;SMTP_ADDRESS&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="390">
            

            

            <code class="ruby">        port: ENV.fetch(&quot;SMTP_PORT&quot;, &quot;587&quot;).to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            

            <code class="ruby">        domain: ENV.fetch(&quot;SMTP_DOMAIN&quot;, ENV.fetch(&quot;MAILER_HOST&quot;, &quot;example.com&quot;)),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="392">
            

            

            <code class="ruby">        user_name: ENV.fetch(&quot;SMTP_USER_NAME&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">        password: ENV.fetch(&quot;SMTP_PASSWORD&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="394">
            

            

            <code class="ruby">        authentication: ENV.fetch(&quot;SMTP_AUTHENTICATION&quot;, &quot;plain&quot;).to_sym,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            

            

            <code class="ruby">        enable_starttls_auto: ENV.fetch(&quot;SMTP_ENABLE_STARTTLS&quot;, &quot;true&quot;) == &quot;true&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="398">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="399">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="00b936eef0f2e1f5509baeb8fdf3f32a124f887e">
  <div class="header">
    <h3>app/services/gmail_oauth_service.rb</h3>
    <h4>
      <span class="green">
  94.37%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>71</b> relevant lines.
      <span class="green"><b>67</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"># GmailOauthService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># Service responsible for managing Gmail OAuth tokens and authentication</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"># for sending emails via Gmail/Google Workspace SMTP with OAuth2.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"># Usage:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">#   # Get authorization URL for user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#   GmailOauthService.authorization_url(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">#   # Exchange authorization code for tokens</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">#   GmailOauthService.exchange_code_for_tokens(user, code)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">#   # Get valid access token (refreshes if needed)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">#   GmailOauthService.valid_access_token(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class GmailOauthService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class &lt;&lt; self</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def authorization_url(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="20">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">      client = build_authorization_client</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="21">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      uri = client.authorization_uri</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="22">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;Gmail OAuth authorization URL generated: #{uri}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="23">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      uri.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def exchange_code_for_tokens(user, code)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="27">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      client = build_authorization_client</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="28">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      client.code = code</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="31">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">        client.fetch_access_token!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        expires_at =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="34">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          if client.expires_at</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="35">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            Time.at(client.expires_at.to_i)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="36">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          elsif client.expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            Time.current + client.expires_in.seconds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            Time.current + 1.hour</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">        update_params = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="43">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">          gmail_access_token: client.access_token,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">          gmail_token_expires_at: expires_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="47">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        if client.refresh_token.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          update_params[:gmail_refresh_token] = client.refresh_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="51">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        user.update!(update_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="53">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[Gmail OAuth] Tokens saved for user #{user.id}, expires at #{expires_at}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="54">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="56">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[Gmail OAuth] Failed to exchange code: #{e.class} #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="57">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="58">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="62">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def valid_access_token(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      # Use existing token if not expired</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="64">
            
              <span class="hits">49</span>
            

            

            <code class="ruby">      if user.gmail_access_token.present? &amp;&amp;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">         user.gmail_token_expires_at.present? &amp;&amp;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">         user.gmail_token_expires_at &gt; 5.minutes.from_now</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">        return user.gmail_access_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      # Cannot refresh without refresh token</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="49" data-linenumber="71">
            
              <span class="hits">49</span>
            

            

            <code class="ruby">      return nil unless user.gmail_refresh_token.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      # Refresh and return updated token</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="74">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      refresh_access_token(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="75">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      user.gmail_access_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="78">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def refresh_access_token(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="79">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      return false unless user.gmail_refresh_token.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="81">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      client = build_refresh_client(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="84">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        client.refresh!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">        expires_at =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="87">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          if client.expires_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">            Time.at(client.expires_at.to_i)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="89">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          elsif client.expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="90">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            Time.current + client.expires_in.seconds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="92">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            Time.current + 1.hour</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="95">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        user.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">          gmail_access_token: client.access_token,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">          gmail_token_expires_at: expires_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="100">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        Rails.logger.info(&quot;[Gmail OAuth] Token refreshed for user #{user.id}, expires at #{expires_at}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="101">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="103">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(&quot;[Gmail OAuth] Failed to refresh token for user #{user.id}: #{e.class} #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="104">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        Rails.logger.error(e.backtrace.join(&quot;\n&quot;)) if e.backtrace</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="105">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="109">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def oauth_configured?(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="110">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      token = valid_access_token(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="111">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      configured = token.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="112">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      refresh_present = user.gmail_refresh_token.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="114">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      Rails.logger.info(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">        &quot;[GmailOauth] oauth_configured? check for user #{user.id}: &quot; \</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">        &quot;token_present=#{configured}, refresh_token_present=#{refresh_present}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="46" data-linenumber="119">
            
              <span class="hits">46</span>
            

            

            <code class="ruby">      configured</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="122">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="124">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_authorization_client</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="125">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      client_id = ENV[&quot;GMAIL_CLIENT_ID&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="126">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      client_secret = ENV[&quot;GMAIL_CLIENT_SECRET&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="128">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">      unless client_id.present? &amp;&amp; client_secret.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="129">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        raise &quot;Gmail OAuth not configured. Please set GMAIL_CLIENT_ID and GMAIL_CLIENT_SECRET.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">      redirect_uri =</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="133">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">        if ENV[&quot;GMAIL_REDIRECT_URI&quot;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">          ENV[&quot;GMAIL_REDIRECT_URI&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="136">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          base_url = ENV.fetch(&quot;MAILER_HOST&quot;, &quot;localhost:3000&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="137">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          base_url = &quot;http://#{base_url}&quot; unless base_url.start_with?(&quot;http&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="138">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          &quot;#{base_url}/oauth/gmail/callback&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="141">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      Rails.logger.info(&quot;[Gmail OAuth] Using redirect_uri: #{redirect_uri}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="143">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">      Signet::OAuth2::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">        authorization_uri: &quot;https://accounts.google.com/o/oauth2/auth&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">        token_credential_uri: &quot;https://oauth2.googleapis.com/token&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">        client_id: client_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">        client_secret: client_secret,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">        redirect_uri: redirect_uri,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">        scope: &quot;https://www.googleapis.com/auth/gmail.send&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">        access_type: &quot;offline&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">        prompt: &quot;consent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="155">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def build_refresh_client(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="156">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      client_id = ENV[&quot;GMAIL_CLIENT_ID&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="157">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      client_secret = ENV[&quot;GMAIL_CLIENT_SECRET&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="159">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      unless client_id.present? &amp;&amp; client_secret.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">        raise &quot;Gmail OAuth not configured. Please set GMAIL_CLIENT_ID and GMAIL_CLIENT_SECRET.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="163">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      Signet::OAuth2::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">        token_credential_uri: &quot;https://oauth2.googleapis.com/token&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">        client_id: client_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">        client_secret: client_secret,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">        refresh_token: user.gmail_refresh_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="98eab4954506e8995ceb4f1647050f1e9fdeb99b">
  <div class="header">
    <h3>app/services/lead_agent_service.rb</h3>
    <h4>
      <span class="green">
  98.73%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>158</b> relevant lines.
      <span class="green"><b>156</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;api_key_service&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/search_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/writer_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/critique_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/design_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"># LeadAgentService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"># Orchestrates the execution of agents (SEARCH  WRITER  CRITIQUE  DESIGN) for a specific lead.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"># Manages agent configuration retrieval, sequential execution, output storage, and stage updates.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"># Usage:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">#   result = LeadAgentService.run_agents_for_lead(lead, campaign, user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">#   # Returns: { status: &#39;completed&#39;|&#39;partial&#39;|&#39;failed&#39;, outputs: {...}, lead: {...} }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class LeadAgentService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  include AgentConstants</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  # Stage progression: queued  searched  written  critiqued  designed  completed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  # Each agent moves the lead to the next stage in the progression</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class &lt;&lt; self</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    # Runs the NEXT agent for a specific lead based on its current stage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # Only runs ONE agent at a time to allow for human review between stages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # @param lead [Lead] The lead to process</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    # @param campaign [Campaign] The campaign containing agent configs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # @param user [User] Current user containing API keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # @return [Hash] Result with status, outputs, and updated lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def run_agents_for_lead(lead, campaign, user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">      # Validate API keys before starting</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="33">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">      unless ApiKeyService.keys_available?(user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        missing_keys = ApiKeyService.missing_keys(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">        return {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">          status: &quot;failed&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">          error: &quot;Missing API keys: #{missing_keys.join(&#39;, &#39;)}. Please add them in the API Keys section.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">          outputs: {},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">          lead: lead</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      # Check if lead is already at final stage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="44">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">      next_agent = determine_next_agent(lead.stage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="45">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">      unless next_agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        # Lead is already at final stage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">        return {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          status: &quot;completed&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">          error: &quot;Lead has already reached the final stage&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">          outputs: {},</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">          lead: lead,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">          completed_agents: [],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">          failed_agents: []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      # Get API keys</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="58">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      gemini_key = ApiKeyService.get_gemini_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="59">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      tavily_key = ApiKeyService.get_tavily_api_key(user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      # Initialize agents</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="62">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      search_agent = Agents::SearchAgent.new(tavily_key: tavily_key, gemini_key: gemini_key)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="63">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      writer_agent = Agents::WriterAgent.new(api_key: gemini_key)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="64">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      critique_agent = Agents::CritiqueAgent.new(api_key: gemini_key)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="65">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      design_agent = Agents::DesignAgent.new(api_key: gemini_key)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      # Track execution results</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="68">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      outputs = {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="69">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      completed_agents = []</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="70">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      failed_agents = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      # Run agents, skipping disabled ones and continuing to the next enabled agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      # Stop after the first successful execution (or failure)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="74">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      max_iterations = 10 # Safety limit to prevent infinite loops</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="75">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      iteration = 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="76">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      agent_executed = false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="78">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      while iteration &lt; max_iterations &amp;&amp; !agent_executed</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="77" data-linenumber="79">
            
              <span class="hits">77</span>
            

            

            <code class="ruby">        iteration += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        # Determine which agent to run based on current stage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="77" data-linenumber="82">
            
              <span class="hits">77</span>
            

            

            <code class="ruby">        next_agent = determine_next_agent(lead.stage)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">        # If already at final stage, break</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="77" data-linenumber="85">
            
              <span class="hits">77</span>
            

            

            <code class="ruby">        unless next_agent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="86">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          break</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        # Get agent config for this campaign</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="90">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">        agent_config = get_agent_config(campaign, next_agent)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">        # Skip if agent is disabled - advance stage and continue to next agent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="76" data-linenumber="93">
            
              <span class="hits">76</span>
            

            

            <code class="ruby">        if agent_config&amp;.disabled?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">          # Still advance stage for disabled agents</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="95">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          advance_stage(lead, next_agent)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="96">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          lead.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">          # Continue to next agent without executing</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="98">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          next</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        # Execute the agent (this is the first enabled agent we found)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">          # Load previous outputs if needed</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="104">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">          previous_outputs = load_previous_outputs(lead, next_agent)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">          # Execute agent based on type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="107">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">          case next_agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">          when AgentConstants::AGENT_SEARCH</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="109">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">            result = execute_search_agent(search_agent, lead, agent_config)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">          when AgentConstants::AGENT_WRITER</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="111">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">            result = execute_writer_agent(writer_agent, lead, agent_config, previous_outputs[AgentConstants::AGENT_SEARCH])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">          when AgentConstants::AGENT_CRITIQUE</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="113">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">            result = execute_critique_agent(critique_agent, lead, agent_config, previous_outputs[AgentConstants::AGENT_WRITER])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">          when AgentConstants::AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="115">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">            result = execute_design_agent(design_agent, lead, agent_config, previous_outputs[AgentConstants::AGENT_CRITIQUE])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">          # Store output</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="119">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          save_agent_output(lead, next_agent, result, AgentConstants::STATUS_COMPLETED)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="120">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          outputs[next_agent] = result</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="121">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          completed_agents &lt;&lt; next_agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">          # Advance to next stage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="124">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          advance_stage(lead, next_agent)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">          # Update lead quality if CRITIQUE completed successfully</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="127">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          if next_agent == AgentConstants::AGENT_CRITIQUE &amp;&amp; result</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="128">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">            update_lead_quality(lead, result)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">          # Mark that we&#39;ve executed an agent and break</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="132">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          agent_executed = true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="133">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">          lead.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">          # Store error output with appropriate fields based on agent type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="137">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          error_output = { error: e.message, agent: next_agent }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">          # Add agent-specific fields for error outputs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="140">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          case next_agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">          when AgentConstants::AGENT_WRITER</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="142">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            error_output[:email] = &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="143">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            error_output[:company] = lead.company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="144">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">            error_output[:recipient] = lead.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">          when AgentConstants::AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="146">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            error_output[:email] = &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="147">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            error_output[:formatted_email] = &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="148">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            error_output[:company] = lead.company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="149">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            error_output[:recipient] = lead.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">          when AgentConstants::AGENT_CRITIQUE</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="151">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">            error_output[&quot;critique&quot;] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">            # error key already set above</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="155">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          save_agent_output(lead, next_agent, error_output, AgentConstants::STATUS_FAILED)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="156">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          outputs[next_agent] = error_output</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="157">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          failed_agents &lt;&lt; next_agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">          # DO NOT advance stage if agent failed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">          # Lead stays at current stage for retry</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">          # Mark as executed and break</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="162">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">          agent_executed = true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">      # Determine overall status</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="167">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      status = determine_status(completed_agents, failed_agents)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">      # Reload lead to get updated attributes</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="170">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      lead.reload</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="173">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">        status: status,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">        outputs: outputs,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">        lead: lead,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">        completed_agents: completed_agents,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">        failed_agents: failed_agents</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="181">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">    # Determines which agent should run next based on current stage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="185">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def determine_next_agent(current_stage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="153" data-linenumber="186">
            
              <span class="hits">153</span>
            

            

            <code class="ruby">      stage_index = AgentConstants::STAGE_PROGRESSION.index(current_stage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="153" data-linenumber="187">
            
              <span class="hits">153</span>
            

            

            <code class="ruby">      return nil if stage_index.nil? || stage_index &gt;= AgentConstants::STAGE_PROGRESSION.length - 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">      # Map stage to next agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">      # queued -&gt; SEARCH (to become &#39;searched&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      # searched -&gt; WRITER (to become &#39;written&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">      # written -&gt; CRITIQUE (to become &#39;critiqued&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">      # critiqued -&gt; DESIGN (to become &#39;designed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">      # designed -&gt; nil (final stage)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="152" data-linenumber="195">
            
              <span class="hits">152</span>
            

            

            <code class="ruby">      case current_stage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">      when AgentConstants::STAGE_QUEUED</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="26" data-linenumber="197">
            
              <span class="hits">26</span>
            

            

            <code class="ruby">        AgentConstants::AGENT_SEARCH</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">      when AgentConstants::STAGE_SEARCHED</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="199">
            
              <span class="hits">45</span>
            

            

            <code class="ruby">        AgentConstants::AGENT_WRITER</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">      when AgentConstants::STAGE_WRITTEN</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="36" data-linenumber="201">
            
              <span class="hits">36</span>
            

            

            <code class="ruby">        AgentConstants::AGENT_CRITIQUE</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">      when AgentConstants::STAGE_CRITIQUED</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="44" data-linenumber="203">
            
              <span class="hits">44</span>
            

            

            <code class="ruby">        AgentConstants::AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">        nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">    # Loads previous agent outputs that are needed for the current agent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="211">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def load_previous_outputs(lead, current_agent)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="212">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      outputs = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">      # WRITER needs SEARCH output</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="215">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      if current_agent == AgentConstants::AGENT_WRITER</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="216">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">        search_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_SEARCH)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="217">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">        outputs[AgentConstants::AGENT_SEARCH] = search_output&amp;.output_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="220">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      if current_agent == AgentConstants::AGENT_CRITIQUE</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="221">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">        writer_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_WRITER)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="222">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">        outputs[AgentConstants::AGENT_WRITER] = writer_output&amp;.output_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="225">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      if current_agent == AgentConstants::AGENT_DESIGN</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="226">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">        critique_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_CRITIQUE)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="227">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">        outputs[AgentConstants::AGENT_CRITIQUE] = critique_output&amp;.output_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="230">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      outputs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby">    # Gets agent configuration for a campaign, creates default if not exists</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="235">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def get_agent_config(campaign, agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="77" data-linenumber="236">
            
              <span class="hits">77</span>
            

            

            <code class="ruby">      campaign.agent_configs.find_by(agent_name: agent_name) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">        campaign.agent_configs.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            

            <code class="ruby">          agent_name: agent_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">          settings: default_settings_for_agent(agent_name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby">          enabled: true  # Enabled by default to allow execution</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            

            <code class="ruby">    # Returns default settings for each agent type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="246">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def default_settings_for_agent(agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="247">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      case agent_name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">      when AgentConstants::AGENT_WRITER</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="249">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        { product_info: &quot;&quot;, sender_company: &quot;&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">      when AgentConstants::AGENT_SEARCH, AgentConstants::AGENT_DESIGN, AgentConstants::AGENT_CRITIQUE</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="251">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">        {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="253">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">    # Executes the SearchAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="259">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def execute_search_agent(search_agent, lead, agent_config)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="260">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      search_agent.run(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby">      company: lead.company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby">      recipient_name: lead.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="263">
            

            

            <code class="ruby">      job_title: lead.title || &quot;&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby">      email: lead.email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            

            <code class="ruby">      tone: agent_config&amp;.settings&amp;.dig(&quot;tone&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            

            <code class="ruby">      persona: agent_config&amp;.settings&amp;.dig(&quot;sender_persona&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="267">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">      goal: (lead.campaign.shared_settings || {})[&quot;primary_goal&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="268">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="270">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            

            <code class="ruby">    # Executes the WriterAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="273">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def execute_writer_agent(writer_agent, lead, agent_config, search_output)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="23" data-linenumber="274">
            
              <span class="hits">23</span>
            

            

            <code class="ruby">      return writer_agent.run({ company: lead.company, sources: [] }, recipient: lead.name, company: lead.company) unless search_output</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="276">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      search_output = search_output.deep_symbolize_keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="277">
            

            

            <code class="ruby">      # Extract unified sources (recipient + company)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="278">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      recipient_sources = Array(search_output.dig(:personalization_signals, :recipient))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="279">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      company_sources   = Array(search_output.dig(:personalization_signals, :company))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="280">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      combined_sources  = (recipient_sources + company_sources).uniq</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="282">
            

            

            <code class="ruby">      search_results = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="283">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">        company: lead.company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="284">
            

            

            <code class="ruby">        sources: combined_sources,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="285">
            

            

            <code class="ruby">        inferred_focus_areas: search_output[:inferred_focus_areas]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="288">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      settings        = agent_config&amp;.settings || {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="289">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      shared_settings = lead.campaign.shared_settings || {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="291">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      product_info   = shared_settings[&quot;product_info&quot;]   || settings[&quot;product_info&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="292">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      sender_company = shared_settings[&quot;sender_company&quot;] || settings[&quot;sender_company&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="293">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="294">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      writer_agent.run(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="295">
            

            

            <code class="ruby">        search_results,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            

            <code class="ruby">        recipient: lead.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby">        company: lead.company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby">        product_info: product_info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="299">
            

            

            <code class="ruby">        sender_company: sender_company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="300">
            

            

            <code class="ruby">        config: { settings: settings },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="301">
            

            

            <code class="ruby">        shared_settings: shared_settings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="302">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="305">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby">    # Executes the CritiqueAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="307">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def execute_critique_agent(critique_agent, lead, agent_config, writer_output)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            

            

            <code class="ruby">      # Prepare writer output for critique</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            

            <code class="ruby">      # Handle both string and symbol keys from JSONB storage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="310">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      email_content = writer_output&amp;.dig(&quot;email&quot;) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            

            <code class="ruby">                      writer_output&amp;.dig(:email) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="312">
            

            

            <code class="ruby">                      writer_output&amp;.dig(&quot;formatted_email&quot;) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="313">
            

            

            <code class="ruby">                      writer_output&amp;.dig(:formatted_email) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby">                      &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="316">
            

            

            <code class="ruby">      # Get variants if they exist</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="317">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      variants = writer_output&amp;.dig(&quot;variants&quot;) || writer_output&amp;.dig(:variants) || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby">      article = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="320">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">        &quot;email_content&quot; =&gt; email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="321">
            

            

            <code class="ruby">        &quot;variants&quot; =&gt; variants,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            

            <code class="ruby">        &quot;number_of_revisions&quot; =&gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="325">
            

            

            <code class="ruby">      # Pass config to critique_agent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="326">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      config_hash = agent_config ? { settings: agent_config.settings } : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="327">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">      result = critique_agent.run(article, config: config_hash)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="329">
            

            

            <code class="ruby">      # If a variant was selected, update the email content</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="330">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      if result[&quot;selected_variant&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="331">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        result[&quot;email&quot;] = result[&quot;selected_variant&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="332">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        result[&quot;email_content&quot;] = result[&quot;selected_variant&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="333">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="335">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      result</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="337">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="338">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">    # Executes the DesignAgent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="340">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def execute_design_agent(design_agent, lead, agent_config, critique_output)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="341">
            

            

            <code class="ruby">      # Prepare critique output for design</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="342">
            

            

            <code class="ruby">      # Prefer selected_variant if available, otherwise use email_content or email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby">      # Handle both string and symbol keys from JSONB storage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="344">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      email_content = critique_output&amp;.dig(&quot;selected_variant&quot;) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            

            

            <code class="ruby">                      critique_output&amp;.dig(:selected_variant) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            

            <code class="ruby">                      critique_output&amp;.dig(&quot;email_content&quot;) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            

            <code class="ruby">                      critique_output&amp;.dig(:email_content) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="348">
            

            

            <code class="ruby">                      critique_output&amp;.dig(&quot;email&quot;) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby">                      critique_output&amp;.dig(:email) ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            

            

            <code class="ruby">                      &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="351">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            

            <code class="ruby">      # Fallback to WRITER output if critique_output doesn&#39;t have email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="353">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      if email_content.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="354">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        writer_output = lead.agent_outputs.find_by(agent_name: AgentConstants::AGENT_WRITER)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="355">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        if writer_output</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="356">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">          email_content = writer_output.output_data[&quot;email&quot;] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="357">
            

            

            <code class="ruby">                         writer_output.output_data[:email] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            

            

            <code class="ruby">                         writer_output.output_data[&quot;formatted_email&quot;] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="359">
            

            

            <code class="ruby">                         writer_output.output_data[:formatted_email] ||</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            

            <code class="ruby">                         &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="361">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="362">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="364">
            

            

            <code class="ruby">      # Get company and recipient from lead</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="365">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      company = lead.company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="366">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      recipient = lead.name</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="367">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="368">
            

            

            <code class="ruby">      # Prepare input hash for design agent</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="369">
            

            

            <code class="ruby">      design_input = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="370">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">        email: email_content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="371">
            

            

            <code class="ruby">        company: company,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            

            

            <code class="ruby">        recipient: recipient</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="374">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="375">
            

            

            <code class="ruby">      # Pass config to design_agent</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="376">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      config_hash = agent_config ? { settings: agent_config.settings } : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="377">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">      design_agent.run(design_input, config: config_hash)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="378">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="379">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="380">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            

            <code class="ruby">    # Extracts domain from lead email or falls back to company name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="382">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def extract_domain_from_lead(lead)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="383">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      if lead.email.present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="384">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        lead.email.split(&quot;@&quot;).last</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="385">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="386">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        lead.company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="387">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="388">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="389">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="390">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            

            <code class="ruby">    # Saves agent output to the database</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="392">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def save_agent_output(lead, agent_name, output_data, status)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="393">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      agent_output = lead.agent_outputs.find_or_initialize_by(agent_name: agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="394">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      agent_output.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            

            

            <code class="ruby">        output_data: output_data,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="396">
            

            

            <code class="ruby">        status: status,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="397">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">        error_message: status == AgentConstants::STATUS_FAILED ? output_data[:error] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="398">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="74" data-linenumber="399">
            
              <span class="hits">74</span>
            

            

            <code class="ruby">      agent_output.save!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="401">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="402">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="403">
            

            

            <code class="ruby">    # Advances lead to the next stage in the progression</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="404">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def advance_stage(lead, agent_name)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="405">
            
              <span class="hits">69</span>
            

            

            <code class="ruby">      current_index = AgentConstants::STAGE_PROGRESSION.index(lead.stage) || -1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="406">
            
              <span class="hits">69</span>
            

            

            <code class="ruby">      next_index = current_index + 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="407">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            

            <code class="ruby">      # Only advance if not already at the final stage</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="409">
            
              <span class="hits">69</span>
            

            

            <code class="ruby">      if next_index &lt; AgentConstants::STAGE_PROGRESSION.length</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="410">
            
              <span class="hits">69</span>
            

            

            <code class="ruby">        new_stage = AgentConstants::STAGE_PROGRESSION[next_index]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="411">
            
              <span class="hits">69</span>
            

            

            <code class="ruby">        lead.update!(stage: new_stage)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="415">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="416">
            

            

            <code class="ruby">    # Updates lead quality based on critique feedback</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="417">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def update_lead_quality(lead, critique_output)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="418">
            

            

            <code class="ruby">      # Simple quality assessment based on critique presence</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="419">
            

            

            <code class="ruby">      # If critique is nil or empty, email was approved (high quality)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="420">
            

            

            <code class="ruby">      # If critique exists, email needs improvement (medium quality)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="421">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      critique = critique_output.is_a?(Hash) ? critique_output[&quot;critique&quot;] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="422">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      quality = (critique.nil? || critique.empty?) ? &quot;high&quot; : &quot;medium&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="423">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="424">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">      if lead.quality != quality</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="425">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">        lead.update!(quality: quality)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="426">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="427">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="428">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="429">
            

            

            <code class="ruby">    ##</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="430">
            

            

            <code class="ruby">    # Determines overall execution status</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="431">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def determine_status(completed_agents, failed_agents)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="75" data-linenumber="432">
            
              <span class="hits">75</span>
            

            

            <code class="ruby">      if failed_agents.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="433">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        &quot;failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="68" data-linenumber="434">
            
              <span class="hits">68</span>
            

            

            <code class="ruby">      elsif completed_agents.any?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="67" data-linenumber="435">
            
              <span class="hits">67</span>
            

            

            <code class="ruby">        &quot;completed&quot;  # Single agent completion is still &#39;completed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="436">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="437">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        &quot;failed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="438">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="439">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="440">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="441">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e1679d29d6c25150cb399592347446f885abcb1f">
  <div class="header">
    <h3>app/services/orchestrator.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>53</b> relevant lines.
      <span class="green"><b>53</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/search_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/writer_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">require_relative &quot;agents/critique_agent&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">=begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">ORCHESTRATOR</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">OVERVIEW:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">The Orchestrator coordinates the multi-agent pipeline to generate personalized B2B marketing emails</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">for target companies. It manages the flow from company name input  research  email generation  quality check.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">WORKFLOW:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">1. Takes company name and optional recipient as input</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">2. Calls SearchAgent to gather real-time news about the target company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">3. Calls WriterAgent to generate personalized B2B email based on research</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">4. Calls CritiqueAgent to review email quality and effectiveness</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">5. Returns finalized email with critique and sources</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">DATA FLOW:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">Input: company_name (e.g., &quot;Microsoft&quot;), recipient (optional, e.g., &quot;John Doe&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">SearchAgent.run(company_name)  {company: &quot;Microsoft&quot;, sources: [...], image: &quot;...&quot;}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">WriterAgent.run(search_results, recipient, company)  {company: &quot;Microsoft&quot;, email: &quot;Subject: ...&quot;, ...}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">CritiqueAgent.run(writer_output)  {critique: &quot;...&quot;}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">Output: {company, recipient, email, critique, sources}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">KEY METHODS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">- initialize: Sets up SearchAgent, WriterAgent, and CritiqueAgent instances</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">- run(company_name, recipient: nil, product_info: nil, sender_company: nil): Executes the full pipeline</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  - Calls SearchAgent to research the target company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  - Calls WriterAgent to generate personalized email TO that company (includes product/sender context)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  - Calls CritiqueAgent to ensure email quality</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  - Returns complete email campaign with sources, critique, and context</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">=end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Orchestrator</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def initialize(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    gemini_api_key: ENV.fetch(&quot;GEMINI_API_KEY&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    tavily_api_key: ENV.fetch(&quot;TAVILY_API_KEY&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    search_agent: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    writer_agent: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    critique_agent: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="47">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    @search_agent = search_agent || Agents::SearchAgent.new(tavily_key: tavily_api_key, gemini_key: gemini_api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="48">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    @writer_agent = writer_agent || Agents::WriterAgent.new(api_key: gemini_api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="49">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    @critique_agent = critique_agent || Agents::CritiqueAgent.new(api_key: gemini_api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def run(company_name, recipient: nil, product_info: nil, sender_company: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="53">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;\n&quot; + &quot;=&quot; * 80</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="54">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;Starting pipeline&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="55">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;=&quot; * 80 + &quot;\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="56">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;Target Company: #{company_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="57">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;Recipient: #{recipient || &#39;General&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="58">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;Your Company: #{sender_company || &#39;Not specified&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="59">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">    # Step 1: Search for information about the company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="62">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    puts &quot;Step 1: Searching for latest news about #{company_name} and #{recipient || &#39;General&#39;}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="63">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    recipient_name = recipient.is_a?(Hash) ? recipient[:name] : recipient</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="64">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    recipient_job_title = recipient.is_a?(Hash) ? recipient[:job_title] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="65">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    recipient_email = recipient.is_a?(Hash) ? recipient[:email] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="66">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    recipient_tone = recipient.is_a?(Hash) ? recipient[:tone] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="67">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    recipient_persona = recipient.is_a?(Hash) ? recipient[:persona] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="68">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    recipient_goal = recipient.is_a?(Hash) ? recipient[:goal] : nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="70">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    search_results = @search_agent.run(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      company: company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      recipient_name: recipient_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      job_title: recipient_job_title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      email: recipient_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      tone: recipient_tone,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">      persona: recipient_persona,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      goal: recipient_goal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    # search_results = @search_agent.run(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    #     company: company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">    #     recipient_name: recipient&amp;.dig(:name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    #     job_title: recipient&amp;.dig(:job_title),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">    #     email: recipient&amp;.dig(:email),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    #     tone: recipient&amp;.dig(:tone),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    #     persona: recipient&amp;.dig(:persona),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    #     goal: recipient&amp;.dig(:goal)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    #   )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="89">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    recipient_sources = Array(search_results.dig(:personalization_signals, :recipient))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="90">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    company_sources   = Array(search_results.dig(:personalization_signals, :company))</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="91">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    sources = recipient_sources + company_sources</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="93">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;Found #{sources.length} sources&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">    # Step 2: Generate personalized email TO the company</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="96">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;Step 2: Generating personalized B2B outreach email...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">    formatted_search_input = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="98">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      company: company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      inferred_focus_areas: search_results[:inferred_focus_areas],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      sources: Array(search_results.dig(:personalization_signals, :company)) # company-focused signals</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="102">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    writer_output = @writer_agent.run(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">      formatted_search_input,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      recipient: recipient_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">      company: company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      product_info: product_info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">      sender_company: sender_company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="109">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    email_text = writer_output[:email] || &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="110">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;Initial Email generated (#{email_text.length} characters)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    # Step 3: Critique and revise until approved</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="113">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;Step 3: Running critique and revision loop...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="114">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    revision_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="115">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    critique_result = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="117">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    loop do</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="118">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      revision_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="119">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      puts &quot;Revision attempt ##{revision_count}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      critique_input = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="122">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">        &quot;email_content&quot; =&gt; email_text,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">        &quot;number_of_revisions&quot; =&gt; revision_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="126">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      critique_result = @critique_agent.run(critique_input)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="127">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      critique_text = critique_result[&quot;critique&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="129">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      if critique_text.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="130">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        puts &quot;CritiqueAgent: Email approved &quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="131">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">        break</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="133">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        puts &quot;CritiqueAgent Feedback: #{critique_text[0..120]}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="134">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        break</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="138">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;\n&quot; + &quot;=&quot; * 80</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="139">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;Pipeline completed successfully!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="140">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">    puts &quot;=&quot; * 80 + &quot;\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="143">
            
              <span class="hits">7</span>
            

            

            <code class="ruby">      company: company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">      recipient: recipient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">      email: email_text,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">      variants: [ email_text ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">      critique: critique_result[&quot;critique&quot;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">      sources: sources,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">      inferred_focus_areas: search_results[:inferred_focus_areas],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">      product_info: product_info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      sender_company: sender_company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="155">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.run(company_name, gemini_api_key: ENV.fetch(&quot;GEMINI_API_KEY&quot;), tavily_api_key: ENV.fetch(&quot;TAVILY_API_KEY&quot;), recipient: nil, product_info: nil, sender_company: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="156">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    new(gemini_api_key: gemini_api_key, tavily_api_key: tavily_api_key).run(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      company_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">      recipient: recipient,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">      product_info: product_info,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">      sender_company: sender_company</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
