#!/usr/bin/env ruby
# Run Cucumber tests with coverage and display summary

ENV['COVERAGE'] = 'true'

require 'json'

puts "=" * 80
puts "Running Cucumber Tests with Coverage"
puts "=" * 80
puts

# Run cucumber
system("bundle exec cucumber --format progress")

puts
puts "=" * 80
puts "Coverage Summary"
puts "=" * 80

# Read coverage results
if File.exist?('coverage/.last_run.json')
  coverage_data = JSON.parse(File.read('coverage/.last_run.json'))
  line_coverage = coverage_data.dig('result', 'line') || 0
  
  puts "Line Coverage: #{format('%.2f', line_coverage)}%"
  puts
  puts "Target: 85.00%"
  puts "Current: #{format('%.2f', line_coverage)}%"
  
  if line_coverage >= 85.0
    puts "✅ Coverage target met!"
  else
    gap = 85.0 - line_coverage
    puts "⚠️  Coverage gap: #{format('%.2f', gap)}%"
    puts
    puts "See CUCUMBER_COVERAGE_PLAN.md for improvement plan"
  end
else
  puts "⚠️  Coverage data not found. Ensure COVERAGE=true is set."
end

puts
puts "Detailed report: coverage/index.html"
puts "=" * 80
